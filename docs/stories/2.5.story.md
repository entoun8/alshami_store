# Story 2.5: Purchase Email Delivery Fix (Critical)

## Status

Draft

## Story

**As a** customer,
**I want** to receive purchase confirmation emails,
**so that** I have proof of my order.

## Problem Statement

The system currently shows successful payment but does not send purchase confirmation emails, even in testing. This is a critical bug affecting customer experience.

## Acceptance Criteria

| #   | Criteria                                                          |
| --- | ----------------------------------------------------------------- |
| AC1 | Root cause of email delivery failure identified                   |
| AC2 | Resend API configuration verified (API key, domain, sender)       |
| AC3 | Email sending logic in webhook handler reviewed                   |
| AC4 | Error logging added to email sending for debugging                |
| AC5 | Email successfully sent after Stripe payment in test mode         |
| AC6 | Email successfully sent after Stripe payment in live mode         |
| AC7 | Email contains correct order details (ID, items, totals, address) |

## Tasks / Subtasks

- [ ] **Task 1: Investigate Root Cause** (AC: 1)
  - [ ] 1.1 Check Resend dashboard for API activity and failed delivery attempts
  - [ ] 1.2 Verify `RESEND_API_KEY` is correctly set in `.env.local`
  - [ ] 1.3 Verify `EMAIL_FROM_ADDRESS` is correctly set in `.env.local`
  - [ ] 1.4 Check Resend account for domain verification status
  - [ ] 1.5 Review Stripe webhook logs for errors via `stripe listen` CLI or Stripe Dashboard
  - [ ] 1.6 Check server logs for `console.error` output from webhook handler
  - [ ] 1.7 Confirm `orderId` metadata is present in PaymentIntent from Stripe events

- [ ] **Task 2: Verify Resend Configuration** (AC: 2)
  - [ ] 2.1 Confirm Resend API key is valid (not expired, correct permissions)
  - [ ] 2.2 Verify sender domain is verified OR use `onboarding@resend.dev` for testing
  - [ ] 2.3 Test Resend API directly with a simple email to confirm connectivity:
    ```typescript
    // Quick test in a temporary script
    import { Resend } from "resend";
    const resend = new Resend(process.env.RESEND_API_KEY);
    await resend.emails.send({
      from: "onboarding@resend.dev",
      to: "your-email@example.com",
      subject: "Test",
      html: "<p>Test email</p>",
    });
    ```
  - [ ] 2.4 If direct test fails, troubleshoot API key or account issues with Resend

- [ ] **Task 3: Review and Fix Email Sending Logic** (AC: 3, 4)
  - [ ] 3.1 Review `lib/email.ts` implementation for any issues
  - [ ] 3.2 Review webhook handler at `app/api/webhooks/stripe/route.ts`
  - [ ] 3.3 Add enhanced error logging to `sendOrderConfirmation`:
    ```typescript
    export async function sendOrderConfirmation(order: OrderWithDetails): Promise<void> {
      console.log("Attempting to send order confirmation email...");
      console.log("To:", order.user_profile.email);
      console.log("Order ID:", order.id);

      try {
        const result = await resend.emails.send({...});
        console.log("Email sent successfully:", result);
      } catch (error) {
        console.error("Resend API error:", error);
        throw error; // Re-throw to be caught by webhook handler
      }
    }
    ```
  - [ ] 3.4 Verify `user_profile.email` is correctly populated from database query
  - [ ] 3.5 Verify `order_item` array is correctly populated from database query
  - [ ] 3.6 Check if Supabase `.select("*, user_profile(*), order_item(*)")` is returning data correctly
  - [ ] 3.7 Add null checks for order data before email send

- [ ] **Task 4: Test Email Delivery in Development** (AC: 5)
  - [ ] 4.1 Start Stripe CLI listener: `stripe listen --forward-to localhost:3000/api/webhooks/stripe`
  - [ ] 4.2 Note the webhook signing secret from Stripe CLI output
  - [ ] 4.3 Ensure `STRIPE_WEBHOOK_SECRET` matches the CLI output
  - [ ] 4.4 Create a test order through the full checkout flow
  - [ ] 4.5 Complete payment with Stripe test card `4242 4242 4242 4242`
  - [ ] 4.6 Observe server logs for email sending output
  - [ ] 4.7 Check inbox for confirmation email
  - [ ] 4.8 If email not received, check spam folder
  - [ ] 4.9 Check Resend dashboard for delivery status
  - [ ] 4.10 Document any errors found and fix iteratively

- [ ] **Task 5: Verify Email Content** (AC: 7)
  - [ ] 5.1 Confirm email contains correct order ID (short format, first 8 chars)
  - [ ] 5.2 Confirm email contains order date in readable format
  - [ ] 5.3 Confirm email contains all order items with correct quantities and prices
  - [ ] 5.4 Confirm email contains shipping address
  - [ ] 5.5 Confirm email contains subtotal, shipping, tax, and total
  - [ ] 5.6 Verify formatting looks professional and readable

- [ ] **Task 6: Test in Production/Live Mode** (AC: 6)
  - [ ] 6.1 Ensure production environment has correct `RESEND_API_KEY`
  - [ ] 6.2 Ensure production environment has correct `EMAIL_FROM_ADDRESS` (verified domain)
  - [ ] 6.3 Ensure production `STRIPE_WEBHOOK_SECRET` is set (from Stripe Dashboard, not CLI)
  - [ ] 6.4 Configure Stripe webhook endpoint in Dashboard pointing to production URL
  - [ ] 6.5 Complete a test purchase in production with live payment
  - [ ] 6.6 Verify email received with correct content
  - [ ] 6.7 Document any production-specific issues and resolve

- [ ] **Task 7: Build and Lint Verification**
  - [ ] 7.1 Run `npm run build` to ensure no build errors
  - [ ] 7.2 Run `npm run lint` to ensure no linting errors
  - [ ] 7.3 Verify no TypeScript errors in modified files

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.7.story.md#qa-results]

Story 1.7 implemented the email functionality with gate status **CONCERNS** because manual testing (Tasks 4.6-4.13) was never completed. The QA noted:

> "Implementation is solid and all ACs are met in code. However, Task 4 (manual testing) is incomplete - items 4.6 through 4.13 are not checked."

This story exists because emails are not being delivered despite the code appearing correct. Possible root causes include:
- Environment variable misconfiguration
- Resend API key issues
- Domain verification issues
- Stripe webhook not triggering
- Order data not being fetched correctly
- Silent failures in email sending

### File Locations

[Source: architecture/7-source-tree.md]

| File                               | Type          | Purpose                                         |
| ---------------------------------- | ------------- | ----------------------------------------------- |
| `lib/email.ts`                     | Utility       | Resend email service with `sendOrderConfirmation` |
| `app/api/webhooks/stripe/route.ts` | Route Handler | Stripe webhook - triggers email after payment   |
| `.env.local`                       | Config        | Environment variables (API keys)                |
| `.env.example`                     | Documentation | Template for required env vars                  |

### Current Implementation Overview

[Source: lib/email.ts, app/api/webhooks/stripe/route.ts]

**Email Service (`lib/email.ts`):**
- Uses Resend SDK to send emails
- `sendOrderConfirmation(order)` function accepts order with related user_profile and order_item data
- Generates professional HTML email template with order details
- Uses `EMAIL_FROM_ADDRESS` env var with fallback to `orders@alshami.com`

**Webhook Handler (`app/api/webhooks/stripe/route.ts`):**
- Verifies Stripe signature before processing
- Handles `payment_intent.succeeded` event
- Updates order `isPaid` and `paidAt` fields
- Fetches complete order with `.select("*, user_profile(*), order_item(*)")`
- Calls `sendOrderConfirmation(order)` in try-catch (non-blocking)
- Logs errors with `console.error()` but returns 200 to prevent Stripe retries

### Environment Variables Required

[Source: architecture/3-tech-stack.md#environment-variables-new]

| Variable                | Purpose                                | Notes                                      |
| ----------------------- | -------------------------------------- | ------------------------------------------ |
| `RESEND_API_KEY`        | Resend email service authentication    | Get from Resend dashboard                  |
| `EMAIL_FROM_ADDRESS`    | Sender address for order confirmations | Must be verified domain or `onboarding@resend.dev` |
| `STRIPE_WEBHOOK_SECRET` | Stripe webhook signature verification  | Different for CLI vs Dashboard             |

**CRITICAL:** The `STRIPE_WEBHOOK_SECRET` is different between:
- **Local development:** Provided by `stripe listen` CLI command
- **Production:** Configured in Stripe Dashboard webhook settings

### Debugging Commands

**Start Stripe CLI listener:**
```bash
stripe listen --forward-to localhost:3000/api/webhooks/stripe
```

**Trigger a test webhook event:**
```bash
stripe trigger payment_intent.succeeded
```

**View recent webhook events in Stripe:**
```bash
stripe events list --limit 10
```

### Common Issues and Solutions

| Issue | Possible Cause | Solution |
|-------|---------------|----------|
| Email not sent | Invalid API key | Verify key in Resend dashboard |
| Email not sent | Domain not verified | Use `onboarding@resend.dev` for testing |
| Email not sent | Webhook not triggered | Check `STRIPE_WEBHOOK_SECRET` matches CLI output |
| Email sent but not received | Spam filter | Check spam folder |
| Email has wrong data | DB query issue | Check `.select()` returns user_profile and order_item |
| 500 error in webhook | Order not found | Verify `orderId` in PaymentIntent metadata |

### Testing Strategy

[Source: architecture/10-testing-strategy.md#story-17-order-confirmation-email-test-cases]

**Manual Test Cases:**

| #       | Test Case                           | Steps                         | Expected Result              |
| ------- | ----------------------------------- | ----------------------------- | ---------------------------- |
| EMAIL-1 | Email sent after payment            | Complete payment, check inbox | Email received               |
| EMAIL-2 | Email contains order details        | Open email                    | Order ID, items, total shown |
| EMAIL-3 | Email failure doesn't break webhook | Simulate email error          | Order still marked paid      |

### Integration Verification

| #   | Verification                                              |
| --- | --------------------------------------------------------- |
| IV1 | Complete test purchase flow â†’ email received              |
| IV2 | Webhook returns 200 regardless of email success/failure   |
| IV3 | Order status updates correctly even if email fails        |
| IV4 | Email delivery logged for monitoring                      |

### Security Considerations

[Source: architecture/11-security-integration.md]

- `RESEND_API_KEY` is server-only (no `NEXT_PUBLIC_` prefix)
- Email errors are logged internally, not exposed to client
- Webhook must return 200 even if email fails to prevent Stripe retries
- Order data comes from verified Stripe event through database query

---

## Testing

### Test File Location

No automated tests - manual testing only (per project testing strategy).

### Testing Standards

Follow the manual test cases documented above. Use Stripe CLI for local testing.

### Testing Framework

N/A - Manual testing with Stripe CLI and Resend dashboard verification.

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-02-01 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent after implementation_
