# Story 2.6: Product Slug Auto-Generation

## Status

Done

## Story

**As an** admin,
**I want** product slugs auto-generated from the product name,
**so that** I don't have to manually create SEO-friendly URLs.

## Acceptance Criteria

| #   | Criteria                                                       |
| --- | -------------------------------------------------------------- |
| AC1 | Slug field auto-populates when admin types product name        |
| AC2 | Slug is kebab-case (lowercase, hyphens instead of spaces)      |
| AC3 | Special characters removed from slug                           |
| AC4 | Slug field is read-only or hidden (not manually editable)      |
| AC5 | Slug uniqueness validated before product creation              |
| AC6 | Existing products with manually entered slugs remain unchanged |
| AC7 | Edit form shows current slug but doesn't allow modification    |

## Tasks / Subtasks

- [x] **Task 1: Create Slug Generation Utility** (AC: 2, 3)
  - [x] 1.1 Add `generateSlug(name: string): string` function to `lib/utils.ts`
  - [x] 1.2 Function should:
    - Convert to lowercase
    - Replace spaces with hyphens
    - Remove special characters (keep only alphanumeric and hyphens)
    - Remove consecutive hyphens
    - Trim leading/trailing hyphens
  - [x] 1.3 Handle edge cases: empty strings, strings with only special characters

- [x] **Task 2: Update AdminProductForm for Create Mode** (AC: 1, 4)
  - [x] 2.1 Import `generateSlug` utility into `AdminProductForm.tsx`
  - [x] 2.2 Update the name field's `onChange` handler to also set the slug:
    - Call `field.onChange(e)` for the name field
    - Call `form.setValue("slug", generateSlug(e.target.value))` in the same handler
  - [x] 2.3 Only auto-generate slug in create mode (`!isEditing`)
  - [x] 2.4 Make slug field read-only:
    - Use `readOnly` attribute on Input
    - Apply visual styling to indicate read-only state (`bg-muted`, `cursor-not-allowed`)
  - [x] 2.5 Display the auto-generated slug as visual feedback

- [x] **Task 3: Update AdminProductForm for Edit Mode** (AC: 6, 7)
  - [x] 3.1 In edit mode (`isEditing = true`), do NOT auto-generate slug
  - [x] 3.2 Display existing slug in read-only field
  - [x] 3.3 Add helper text explaining "Slug cannot be changed after creation"
  - [x] 3.4 Ensure existing products' slugs are preserved on update

- [x] **Task 4: Add Slug Uniqueness Validation** (AC: 5)
  - [x] 4.1 Add `checkSlugExists(slug: string, excludeProductId?: number): Promise<boolean>` to `lib/data-service.ts`
  - [x] 4.2 Function queries `Product` table for matching slug
  - [x] 4.3 `excludeProductId` parameter allows excluding current product during edit
  - [x] 4.4 Update `createProduct` Server Action to check slug uniqueness before insert
  - [x] 4.5 Return clear error message if slug already exists: "A product with this slug already exists. Please use a different name."

- [x] **Task 5: Handle Slug Collision Edge Cases** (AC: 5)
  - [x] 5.1 If slug already exists, append a numeric suffix (e.g., `product-name-2`)
  - [x] 5.2 Keep incrementing suffix until unique slug found
  - [x] 5.3 Display the final slug to admin before submission
  - [ ] 5.4 Consider adding a "Regenerate Slug" button (optional enhancement)

- [x] **Task 6: Build and Lint Verification**
  - [x] 6.1 Run `npm run build` to ensure no build errors
  - [x] 6.2 Run `npm run lint` to ensure no linting errors
  - [x] 6.3 Verify no TypeScript errors in modified files

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.8.story.md, docs/stories/2.1.story.md]

Story 1.8 implemented the AdminProductForm with manual slug entry. Story 2.1 verified all security configurations are correct. The current form has a fully editable slug field that needs to be changed to auto-generated + read-only.

### Current Implementation Overview

[Source: components/admin/AdminProductForm.tsx]

**Current Slug Field (lines 93-108):**

```tsx
<FormField
  control={form.control}
  name="slug"
  render={({ field }) => (
    <FormItem>
      <FormLabel>Slug</FormLabel>
      <FormControl>
        <Input
          placeholder="product-slug"
          className="bg-background border-input"
          {...field}
        />
      </FormControl>
      <FormMessage />
    </FormItem>
  )}
/>
```

This needs to be modified to:

1. Be read-only in create mode (auto-generated from name)
2. Be read-only in edit mode (preserve existing slug)
3. Show visual feedback that it's auto-generated

### Slug Generation Algorithm

[Source: No specific architecture doc - standard SEO slug pattern]

```typescript
export function generateSlug(name: string): string {
  return name
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, "") // Remove special characters
    .replace(/\s+/g, "-") // Replace spaces with hyphens
    .replace(/-+/g, "-") // Replace multiple hyphens with single
    .replace(/^-|-$/g, ""); // Remove leading/trailing hyphens
}
```

### Form Patterns

[Source: architecture/9-coding-standards.md#form-handling-pattern]

**React Hook Form with onChange handler (recommended):**

```tsx
"use client";

import { useForm } from "react-hook-form";
import { generateSlug } from "@/lib/utils";

export function AdminProductForm({ product }: Props) {
  const isEditing = !!product;

  const form = useForm({
    resolver: zodResolver(insertProductSchema),
    defaultValues: { name: "", slug: "", ... },
  });

  return (
    <Form {...form}>
      <FormField
        control={form.control}
        name="name"
        render={({ field }) => (
          <FormItem>
            <FormLabel>Name</FormLabel>
            <FormControl>
              <Input
                placeholder="Product name"
                {...field}
                onChange={(e) => {
                  field.onChange(e); // Update name field
                  if (!isEditing) {
                    form.setValue("slug", generateSlug(e.target.value));
                  }
                }}
              />
            </FormControl>
            <FormMessage />
          </FormItem>
        )}
      />
      {/* slug field is read-only */}
    </Form>
  );
}
```

**Why onChange over useEffect:**

- No extra render cycles
- Explicit data flow
- React Hook Form recommended pattern for updating related fields

### File Locations

[Source: architecture/7-source-tree.md]

| File                                    | Type          | Modification                                   |
| --------------------------------------- | ------------- | ---------------------------------------------- |
| `lib/utils.ts`                          | Utility       | Add `generateSlug()` function                  |
| `components/admin/AdminProductForm.tsx` | Component     | Add slug auto-generation, make field read-only |
| `lib/data-service.ts`                   | Service       | Add `checkSlugExists()` function               |
| `lib/actions.ts`                        | Server Action | Add slug uniqueness check to `createProduct`   |

### Data Model Reference

[Source: architecture/4-data-models-and-schema-changes.md]

**Product Table:**

- `slug` column: string, unique, indexed
- Used for product detail page URLs: `/products/[slug]`

### Validation Schema

[Source: lib/validators.ts]

```typescript
export const insertProductSchema = z.object({
  name: z.string().min(3, "Name must be at least 3 characters"),
  slug: z.string().min(3, "Slug must be at least 3 characters"),
  // ... other fields
});
```

The slug validation remains unchanged - we just auto-generate it instead of manual entry.

### UI Styling for Read-Only Field

[Source: architecture/9-coding-standards.md#color-system]

Use semantic CSS variables for read-only state:

```tsx
<Input
  readOnly
  className="bg-muted text-muted-foreground cursor-not-allowed border-input"
  {...field}
/>
```

### Integration Points

| Integration      | Details                                                  |
| ---------------- | -------------------------------------------------------- |
| Form State       | Use `form.setValue()` in name field's `onChange` handler |
| URL Generation   | Generated slug used in `/products/[slug]` routing        |
| Database         | Slug stored in `Product.slug` column                     |
| Uniqueness Check | Query `Product` table for existing slugs                 |

---

## Testing

### Test File Location

No automated tests - manual testing only (per project testing strategy).

### Testing Standards

[Source: architecture/10-testing-strategy.md#story-18-admin-dashboard-test-cases]

| #      | Test Case                     | Steps                                     | Expected Result                    |
| ------ | ----------------------------- | ----------------------------------------- | ---------------------------------- |
| SLUG-1 | Slug auto-generates from name | Type "Premium Coffee Beans" in name field | Slug shows "premium-coffee-beans"  |
| SLUG-2 | Slug updates as name changes  | Modify name to "Organic Coffee"           | Slug updates to "organic-coffee"   |
| SLUG-3 | Special characters removed    | Type "Caf√© & Tea (Special!)"              | Slug shows "caf-tea-special"       |
| SLUG-4 | Slug is read-only in create   | Try to edit slug field                    | Field is not editable              |
| SLUG-5 | Edit mode shows existing slug | Edit a product                            | Original slug displayed, read-only |
| SLUG-6 | Duplicate slug shows error    | Create product with existing name         | Error message about duplicate slug |
| SLUG-7 | Product accessible by slug    | Create product, visit `/products/[slug]`  | Product page loads correctly       |

### Testing Framework

Manual testing with browser DevTools and admin dashboard.

---

## Change Log

| Date       | Version | Description             | Author            |
| ---------- | ------- | ----------------------- | ----------------- |
| 2026-02-07 | 1.0     | Initial story draft     | SM Agent (Bob)    |
| 2026-02-07 | 1.1     | Implementation complete | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- Added `generateSlug()` utility function to convert product names to SEO-friendly slugs
- Updated AdminProductForm to auto-generate slug from name field in create mode
- Slug field is now read-only with visual styling (`bg-muted`, `cursor-not-allowed`)
- Added helper text showing "Auto-generated from product name" (create) or "Slug cannot be changed after creation" (edit)
- Added `checkSlugExists()` and `findUniqueSlug()` functions to data-service.ts for uniqueness validation
- Added `getUniqueSlug()` server action for client-side preview of final unique slug
- Updated `createProduct` action to ensure slug uniqueness by appending numeric suffix if needed
- On name field blur, the form checks for slug uniqueness and updates display to show final slug
- Task 5.4 (Regenerate Slug button) marked as optional enhancement, not implemented

### File List

| File                                    | Action   | Description                                                                    |
| --------------------------------------- | -------- | ------------------------------------------------------------------------------ |
| `lib/utils.ts`                          | Modified | Added `generateSlug()` function                                                |
| `lib/data-service.ts`                   | Modified | Added `checkSlugExists()` and `findUniqueSlug()` functions                     |
| `lib/actions.ts`                        | Modified | Added `getUniqueSlug()` action, updated `createProduct` to ensure unique slugs |
| `components/admin/AdminProductForm.tsx` | Modified | Auto-generate slug, read-only field, onBlur uniqueness check                   |

---

## QA Results

_To be filled by QA Agent after implementation_
