# Story 1.3: User Profile Page

## Status

Done

## Story

**As a** logged-in customer,
**I want** to view and edit my profile information,
**so that** I can manage my account details and save my shipping address.

## Acceptance Criteria

| #   | Criteria                                                                  |
| --- | ------------------------------------------------------------------------- |
| AC1 | Profile page exists at `/user/profile` and requires authentication        |
| AC2 | Page displays user's name, email, and profile image                       |
| AC3 | Page displays user's saved shipping address (from `user_profile.address`) |
| AC4 | User can edit their full name via a form                                  |
| AC5 | User can edit/add their shipping address                                  |
| AC6 | Form uses React Hook Form + Zod validation                                |
| AC7 | Success/error feedback via Sonner toast                                   |
| AC8 | Unauthenticated users are redirected to sign-in                           |
| AC9 | Profile link accessible from user dropdown menu                           |

## Tasks / Subtasks

- [x] **Task 1: Install required shadcn components** (AC: 2)
  - [x] 1.1 Run `npx shadcn@latest add avatar` (if not already installed)
  - [x] 1.2 Verify Avatar component exists in `components/ui/avatar.tsx`

- [x] **Task 2: Create profile page route** (AC: 1, 8)
  - [x] 2.1 Create directory structure: `app/(root)/user/profile/`
  - [x] 2.2 Create `app/(root)/user/profile/page.tsx` as Server Component
  - [x] 2.3 Implement authentication check using `auth()` from `@/lib/auth`
  - [x] 2.4 Redirect unauthenticated users using `redirect("/sign-in")` from `next/navigation`
  - [x] 2.5 Fetch user profile data using `getUserById(session.user.profileId)`
  - [x] 2.6 Render page with `.wrapper` class and `h1-bold` title

- [x] **Task 3: Create updateProfileSchema validator** (AC: 6)
  - [x] 3.1 Add `updateProfileSchema` to `lib/validators.ts`
  - [x] 3.2 Schema should include: `fullName: z.string().min(3)` and reuse `shippingAddressSchema` for address
  - [x] 3.3 Export the new schema

- [x] **Task 4: Create updateUserProfile Server Action** (AC: 4, 5, 7)
  - [x] 4.1 Add `updateUserProfile` function to `lib/actions.ts`
  - [x] 4.2 Verify user is authenticated via `auth()`
  - [x] 4.3 Validate input with `updateProfileSchema`
  - [x] 4.4 Update `user_profile` table (both `full_name` and `address` fields)
  - [x] 4.5 Call `revalidatePath("/user/profile")`
  - [x] 4.6 Return `{ success: boolean, message: string }` response

- [x] **Task 5: Create UserProfileForm component** (AC: 2, 3, 4, 5, 6, 7)
  - [x] 5.1 Create `components/user/` directory
  - [x] 5.2 Create `components/user/UserProfileForm.tsx` as Client Component
  - [x] 5.3 Use React Hook Form with `zodResolver(updateProfileSchema)`
  - [x] 5.4 Use `useTransition` for pending state management
  - [x] 5.5 Display user avatar using shadcn Avatar component with fallback initials
  - [x] 5.6 Display email as read-only (not editable)
  - [x] 5.7 Create editable Full Name input field
  - [x] 5.8 Create shipping address fields (reuse structure from ShippingAddressForm)
  - [x] 5.9 Add Save button with loading state
  - [x] 5.10 Call `updateUserProfile` Server Action on submit
  - [x] 5.11 Display toast messages using Sonner for success/error feedback

- [x] **Task 6: Add Profile link to UserMenu** (AC: 9)
  - [x] 6.1 Modify `components/authentication/UserMenu.tsx`
  - [x] 6.2 Add `DropdownMenuItem` with Link to `/user/profile`
  - [x] 6.3 Import `Link` from `next/link`
  - [x] 6.4 Add User icon from Lucide React
  - [x] 6.5 Position before Sign Out option

- [x] **Task 7: Add UserProfile type to types.ts** (if needed)
  - [x] 7.1 Check if `UserProfile` type exists in `types.ts`
  - [x] 7.2 If not, add type that matches `user_profile` table schema including address field

- [ ] **Task 8: Manual Integration Testing**
  - [ ] 8.1 Visit `/user/profile` logged out - verify redirect to sign-in (AC: 8, PROF-1)
  - [ ] 8.2 Visit `/user/profile` logged in - verify name, email, image shown (AC: 2, PROF-2)
  - [ ] 8.3 Edit name and save - verify update and toast (AC: 4, PROF-3)
  - [ ] 8.4 Edit address and save - verify update and toast (AC: 5, PROF-4)
  - [ ] 8.5 Submit invalid data - verify validation errors (AC: 6, PROF-5)
  - [ ] 8.6 Verify Profile link works in user dropdown (AC: 9)
  - [ ] 8.7 Verify existing user dropdown still functions (IV1)
  - [ ] 8.8 Verify profile updates persist in database (IV2)

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.2.story.md#dev-agent-record]

Story 1.2 established patterns for:

- Using `redirect()` from `next/navigation` for page redirects
- Minimal, focused implementations
- QA discovered missed internal links - thoroughly check all integration points

### Data Models

[Source: architecture/4-data-models-and-schema-changes.md#existing-database-schema]

**user_profile table structure:**

```
| Column         | Type      | Notes                           |
|----------------|-----------|--------------------------------|
| id             | UUID      | Primary key                     |
| email          | string    | Unique, from OAuth              |
| full_name      | string    | Editable by user                |
| image          | string    | Profile image URL from OAuth    |
| role           | string    | 'user' or 'admin'              |
| address        | JSONB     | ShippingAddress schema          |
| payment_method | string    | Selected payment method         |
| created_at     | timestamp |                                |
| updated_at     | timestamp |                                |
```

**ShippingAddress schema (reuse existing):**

```typescript
// From lib/validators.ts
shippingAddressSchema = z.object({
  fullName: z.string().min(3),
  streetAddress: z.string().min(3),
  city: z.string().min(3),
  postalCode: z.string().min(3),
  country: z.string().min(3),
});
```

### API Specifications

[Source: architecture/6-api-design-and-integration.md#updateuserprofile]

**updateUserProfile Server Action:**

```typescript
"use server";

export async function updateUserProfile(data: {
  fullName: string;
  address: ShippingAddress;
}): Promise<{ success: boolean; message: string }> {
  // 1. Get session, verify authenticated
  // 2. Validate data with Zod schema
  // 3. Update user_profile via Supabase (anon key - RLS handles auth)
  // 4. Revalidate /user/profile path
  // 5. Return success/error
}
```

**Request Schema (add to lib/validators.ts):**

```typescript
export const updateProfileSchema = z.object({
  fullName: z.string().min(3, "Name must be at least 3 characters"),
  address: shippingAddressSchema,
});
```

### Component Specifications

[Source: architecture/5-component-architecture.md#userprofileform-component-story-13]

**UserProfileForm Component:**

- **Location:** `components/user/UserProfileForm.tsx`
- **Type:** Client Component ("use client")
- **Props:** `{ user: UserProfile }` where UserProfile includes id, email, full_name, image, address
- **Form fields:** fullName (editable), address (nested: streetAddress, city, postalCode, country)
- **Dependencies:** shadcn `Avatar`, `Form`, `FormField`, `Input`, `Button`, `Card`
- **Pattern:** Follow `ShippingAddressForm.tsx` structure for form handling

**Key imports to use:**

```typescript
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useTransition } from "react";
import { toast } from "sonner";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import {
  Form,
  FormField,
  FormItem,
  FormLabel,
  FormControl,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
```

### File Locations

[Source: architecture/7-source-tree.md#new-files-summary]

| File                                     | Type               | Purpose                              |
| ---------------------------------------- | ------------------ | ------------------------------------ |
| `app/(root)/user/profile/page.tsx`       | NEW                | Profile page (Server Component)      |
| `components/user/UserProfileForm.tsx`    | NEW                | Profile edit form (Client Component) |
| `lib/validators.ts`                      | MODIFY             | Add `updateProfileSchema`            |
| `lib/actions.ts`                         | MODIFY             | Add `updateUserProfile` action       |
| `components/authentication/UserMenu.tsx` | MODIFY             | Add Profile link                     |
| `types.ts`                               | MODIFY (if needed) | Add `UserProfile` type               |

### Coding Standards

[Source: architecture/9-coding-standards.md]

**UI Standards:**

- Use `.wrapper` class for page containers
- Use `.h1-bold`, `.h2-bold` for headings
- Use semantic CSS variables: `bg-background`, `text-foreground`, `bg-card`, etc.
- Never use arbitrary Tailwind colors like `bg-blue-500`

**Form Handling Pattern:**

```tsx
"use client";

export function UserProfileForm({ user }: Props) {
  const [isPending, startTransition] = useTransition();
  const form = useForm({ resolver: zodResolver(updateProfileSchema), defaultValues: ... });

  const onSubmit = (data: FormData) => {
    startTransition(async () => {
      const result = await updateUserProfile(data);
      if (result.success) {
        toast.success(result.message);
      } else {
        toast.error(result.message);
      }
    });
  };

  return <Form {...form}>...</Form>;
}
```

**Server Action Pattern:**

```typescript
"use server";

export async function updateUserProfile(data: ...): Promise<{ success: boolean; message: string }> {
  try {
    const session = await auth();
    if (!session?.user?.profileId) {
      return { success: false, message: "Unauthorized" };
    }

    const validated = updateProfileSchema.parse(data);

    const { error } = await supabase
      .from("user_profile")
      .update({ full_name: validated.fullName, address: validated.address })
      .eq("id", session.user.profileId);

    if (error) throw error;

    revalidatePath("/user/profile");
    return { success: true, message: "Profile updated successfully" };
  } catch (error) {
    return { success: false, message: formatError(error) };
  }
}
```

### Existing Code Patterns to Reference

[Source: Code review of existing components]

**ShippingAddressForm.tsx (lines 32-188):**

- Use as template for form structure
- Reuse address field layout (fullName, streetAddress, city+postalCode grid, country)
- Follow same Input styling: `className="bg-background border-input"`

**UserMenu.tsx (lines 23-73):**

- Add new `DropdownMenuItem` before SignOutButton
- Use `Link` from next/link for navigation
- Example: `<DropdownMenuItem asChild><Link href="/user/profile">Profile</Link></DropdownMenuItem>`

**data-service.ts getUserById (lines 73-85):**

- Already fetches all user_profile fields including `address`
- Use this function to get user data in the profile page

### Technical Constraints

[Source: architecture/9-coding-standards.md#critical-integration-rules]

- Import organization: React → Third-party → Internal (@/) → Relative
- All Server Actions return `{ success: boolean, message: string }`
- Use `formatError()` from `@/lib/utils` for error messages
- Use `@/` path alias for all imports from project root
- Never modify existing function signatures - add new functions alongside

### Testing

[Source: architecture/10-testing-strategy.md#story-13-user-profile-test-cases]

**Manual Test Cases:**

| #      | Test Case                  | Steps                            | Expected Result            |
| ------ | -------------------------- | -------------------------------- | -------------------------- |
| PROF-1 | Profile page requires auth | Visit `/user/profile` logged out | Redirected to sign-in      |
| PROF-2 | Profile displays user data | Log in, visit profile            | Name, email, image shown   |
| PROF-3 | Can update name            | Edit name, save                  | Name updated, toast shown  |
| PROF-4 | Can update address         | Edit address fields, save        | Address saved, toast shown |
| PROF-5 | Validation works           | Submit invalid data              | Error messages displayed   |

**Integration Verification:**

| #   | Verification                                     |
| --- | ------------------------------------------------ |
| IV1 | Existing user dropdown menu still functions      |
| IV2 | Profile updates persist correctly in database    |
| IV3 | RLS allows user to update only their own profile |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-01-18 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed async `formatError()` call in `updateUserProfile` action (was missing `await`)

### Completion Notes List

- Avatar component was already installed (verified at `components/ui/avatar.tsx`)
- Created profile page with auth check and redirect for unauthenticated users
- Added `updateProfileSchema` validator reusing existing `shippingAddressSchema`
- Created `updateUserProfile` Server Action with proper auth, validation, and error handling
- Built `UserProfileForm` component following `ShippingAddressForm` patterns
- Added Profile link with User icon to UserMenu dropdown before Sign Out
- Added `UserProfile` type to `types.ts` matching database schema
- Build passes with no errors; lint passes

### File List

| File                                     | Status   | Purpose                                 |
| ---------------------------------------- | -------- | --------------------------------------- |
| `app/(root)/user/profile/page.tsx`       | NEW      | Profile page Server Component           |
| `components/user/UserProfileForm.tsx`    | NEW      | Profile edit form Client Component      |
| `lib/validators.ts`                      | MODIFIED | Added `updateProfileSchema`             |
| `lib/actions.ts`                         | MODIFIED | Added `updateUserProfile` Server Action |
| `components/authentication/UserMenu.tsx` | MODIFIED | Added Profile link with User icon       |
| `types.ts`                               | MODIFIED | Added `UserProfile` type                |

### Change Log

| Date       | Change                 | Reason                |
| ---------- | ---------------------- | --------------------- |
| 2026-01-18 | Initial implementation | Story 1.3 development |

---

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation is clean, well-structured, and follows all established project patterns. The code demonstrates good separation of concerns with a Server Component handling authentication and data fetching, while the Client Component manages form state and user interaction.

Key Strengths:

- Proper authentication flow with redirect for unauthenticated users
- Correct use of React Hook Form + Zod validation pattern
- Toast notifications for user feedback
- Semantic CSS variables and utility classes throughout
- Reuses existing `shippingAddressSchema` for consistency

### Refactoring Performed

None required - implementation is well-structured and follows project conventions.

### Compliance Check

- Coding Standards: ✓ Uses `.wrapper`, typography utilities, semantic colors
- Project Structure: ✓ Files in correct locations per architecture spec
- Testing Strategy: ✓ Manual test cases defined (pending execution)
- All ACs Met: ✓ All 9 acceptance criteria fully implemented

### Improvements Checklist

- [x] Profile page requires authentication (AC1, AC8)
- [x] User info displayed with Avatar (AC2)
- [x] Shipping address displayed and editable (AC3, AC5)
- [x] Full name editable (AC4)
- [x] React Hook Form + Zod validation (AC6)
- [x] Toast feedback on save (AC7)
- [x] Profile link in UserMenu (AC9)
- [ ] Extract duplicated initials logic to shared utility (future improvement)
- [ ] Add automated tests for updateProfileSchema and Server Action (future sprint)

### Security Review

**Status: PASS**

- Authentication check in Server Component before accessing user data
- Server Action validates session before database update
- Uses `session.user.profileId` to scope update to authenticated user only
- No direct user input used in SQL queries (Supabase handles parameterization)

### Performance Considerations

**Status: PASS**

- Single database query for user profile data
- Path revalidation scoped to `/user/profile` only
- No N+1 queries or unnecessary fetches

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.3-user-profile-page.yml

### Recommended Status

**✓ Ready for Done** - All acceptance criteria implemented, build passes, lint passes. Manual testing (Task 8) should be completed by the team before final closure.
