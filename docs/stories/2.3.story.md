# Story 2.3: Loading States & Deployment Readiness

## Status

Approved

## Story

**As a** customer,
**I want** smooth loading experiences,
**so that** I never see broken, flashing, or incomplete UI states.

## Acceptance Criteria

| #   | Criteria                                                   |
| --- | ---------------------------------------------------------- |
| AC1 | All async data fetching has appropriate loading states     |
| AC2 | Loading skeletons used where data takes time to load       |
| AC3 | No layout shift during loading transitions                 |
| AC4 | Error boundaries handle component failures gracefully      |
| AC5 | `npm run build` completes without errors                   |
| AC6 | `npm run lint` passes without errors                       |
| AC7 | No console errors in browser during normal usage           |
| AC8 | All pages load correctly in production build (`npm start`) |

## Tasks / Subtasks

- [ ] **Task 1: Audit Existing Loading States** (AC: 1, 2)
  - [ ] 1.1 Inventory all pages with async data fetching
  - [ ] 1.2 Document which pages have `loading.tsx` files
  - [ ] 1.3 Document which pages are missing loading states
  - [ ] 1.4 Review existing skeleton components in `components/products/`

- [ ] **Task 2: Add Missing Loading States for User Pages** (AC: 1, 2, 3)
  - [ ] 2.1 Create `app/(root)/user/profile/loading.tsx` with profile form skeleton
  - [ ] 2.2 Create `app/(root)/user/orders/loading.tsx` with order list skeleton
  - [ ] 2.3 Ensure skeletons match the exact layout of loaded content (prevent layout shift)

- [ ] **Task 3: Add Missing Loading States for Order Flow** (AC: 1, 2, 3)
  - [ ] 3.1 Create `app/(root)/order/[id]/loading.tsx` with order detail skeleton
  - [ ] 3.2 Create `app/(root)/cart/loading.tsx` if cart page has async data
  - [ ] 3.3 Create `app/(root)/place-order/loading.tsx` with order review skeleton
  - [ ] 3.4 Ensure checkout pages have appropriate loading indicators

- [ ] **Task 4: Add Missing Loading States for Admin Pages** (AC: 1, 2, 3)
  - [ ] 4.1 Create `app/(admin)/admin/products/loading.tsx` with product table skeleton
  - [ ] 4.2 Create `app/(admin)/admin/products/[id]/edit/loading.tsx` with form skeleton
  - [ ] 4.3 Create `app/(admin)/admin/products/new/loading.tsx` with form skeleton (or share with edit)

- [ ] **Task 5: Add Missing Loading States for Product Detail** (AC: 1, 2, 3)
  - [ ] 5.1 Create `app/(root)/products/[slug]/loading.tsx` with product detail skeleton
  - [ ] 5.2 Include skeleton for product image, title, description, price, add to cart button

- [ ] **Task 6: Verify Error Boundary Coverage** (AC: 4)
  - [ ] 6.1 Verify `app/error.tsx` exists and handles global errors
  - [ ] 6.2 Test error boundary by temporarily throwing an error in a component
  - [ ] 6.3 Verify error UI provides retry and refresh options
  - [ ] 6.4 Consider adding route-specific error.tsx files if needed for better UX

- [ ] **Task 7: Verify Layout Shift Prevention** (AC: 3)
  - [ ] 7.1 Test each page with network throttling enabled (Slow 3G)
  - [ ] 7.2 Verify skeleton dimensions match final content dimensions
  - [ ] 7.3 Fix any skeletons that cause layout shift on content load
  - [ ] 7.4 Test on mobile viewport for responsive layout shift issues

- [ ] **Task 8: Console Error Audit** (AC: 7)
  - [ ] 8.1 Navigate through all pages with browser DevTools console open
  - [ ] 8.2 Document any console errors or warnings
  - [ ] 8.3 Fix React hydration errors if any
  - [ ] 8.4 Fix missing key warnings in list renders
  - [ ] 8.5 Fix invalid prop warnings
  - [ ] 8.6 Ignore third-party library warnings (document them)

- [ ] **Task 9: Build Verification** (AC: 5, 6)
  - [ ] 9.1 Run `npm run lint` and fix any linting errors
  - [ ] 9.2 Run `npm run build` and fix any build errors
  - [ ] 9.3 Document any TypeScript errors found and fix them

- [ ] **Task 10: Production Build Testing** (AC: 8)
  - [ ] 10.1 Run `npm run build && npm start`
  - [ ] 10.2 Navigate through all major pages in production mode
  - [ ] 10.3 Verify all pages load correctly without JS errors
  - [ ] 10.4 Test the following critical flows:
    - [ ] 10.4.1 Products page with filtering and pagination
    - [ ] 10.4.2 Product detail page
    - [ ] 10.4.3 Cart add/remove/update
    - [ ] 10.4.4 Checkout flow (shipping → payment → place order)
    - [ ] 10.4.5 Order detail page
    - [ ] 10.4.6 User profile page
    - [ ] 10.4.7 Order history page
    - [ ] 10.4.8 Admin products page (as admin user)
  - [ ] 10.5 Test dark mode on all pages

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.2.story.md#dev-agent-record]

Story 2.2 (Codebase Consistency Review) verified that the codebase follows consistent patterns. Build and lint pass successfully. This story builds on that foundation by ensuring smooth loading experiences throughout the application.

[Source: docs/stories/2.7.story.md#dev-agent-record]

Story 2.7 confirmed `npm run build` and `npm run lint` pass. The codebase is stable and ready for loading state improvements.

### Existing Loading Infrastructure

[Source: Codebase analysis]

**Existing `loading.tsx` Files:**

| Location                          | Purpose                       |
| --------------------------------- | ----------------------------- |
| `app/(root)/loading.tsx`          | Root route group loading      |
| `app/(root)/products/loading.tsx` | Products listing page loading |

**Existing Skeleton Components:**

| Component                                     | Purpose                 |
| --------------------------------------------- | ----------------------- |
| `components/products/ProductCardSkeleton.tsx` | Individual product card |
| `components/products/ProductListSkeleton.tsx` | Grid of product cards   |
| `components/ui/skeleton.tsx`                  | Base shadcn skeleton    |

**Existing Error Boundary:**

| File            | Type         | Coverage   |
| --------------- | ------------ | ---------- |
| `app/error.tsx` | Global error | Entire app |

### Pages Requiring Loading States

[Source: app/**/page.tsx analysis]

**Pages with Async Data (need loading states):**

| Page                                            | Data Fetched          | Priority |
| ----------------------------------------------- | --------------------- | -------- |
| `app/(root)/products/[slug]/page.tsx`           | Product by slug       | High     |
| `app/(root)/cart/page.tsx`                      | User's cart           | Medium   |
| `app/(root)/order/[id]/page.tsx`                | Order details         | High     |
| `app/(root)/place-order/page.tsx`               | Cart for order review | Medium   |
| `app/(root)/user/profile/page.tsx`              | User profile          | High     |
| `app/(root)/user/orders/page.tsx`               | User's order history  | High     |
| `app/(admin)/admin/products/page.tsx`           | All products          | Medium   |
| `app/(admin)/admin/products/[id]/edit/page.tsx` | Product by ID         | Medium   |

**Static Pages (no loading needed):**

- `app/(root)/about/page.tsx` - Static content
- `app/(root)/contact/page.tsx` - Static content
- `app/(auth)/sign-in/page.tsx` - Auth form
- `app/(admin)/admin/products/new/page.tsx` - Empty form

### Skeleton Pattern Reference

[Source: architecture/9-coding-standards.md, existing loading.tsx files]

**Standard Loading File Pattern:**

```tsx
import { Skeleton } from "@/components/ui/skeleton";

export default function Loading() {
  return (
    <div className="wrapper">
      {/* Skeleton matching page layout */}
      <Skeleton className="h-10 w-64 mb-6" />
      {/* More skeletons... */}
    </div>
  );
}
```

**Key Skeleton Classes:**

- Use `Skeleton` from `@/components/ui/skeleton`
- Match exact dimensions of content with height/width classes
- Use `aspect-square` for image placeholders
- Use `.wrapper` class for container
- Use same grid layouts as actual content

### Layout Shift Prevention Guidelines

[Source: architecture/9-coding-standards.md#ui-development-standards]

To prevent Cumulative Layout Shift (CLS):

1. **Match dimensions exactly**: Skeleton height/width should match final content
2. **Use same containers**: Apply `.wrapper` and grid classes to loading state
3. **Reserve space for images**: Use `aspect-square` or fixed dimensions
4. **Consistent padding/margins**: Match spacing between skeleton and content

### Error Boundary Pattern

[Source: app/error.tsx]

The existing error boundary follows Next.js patterns:

- Uses `"use client"` directive
- Receives `error` and `reset` props
- Logs error to console
- Provides "Try Again" and "Reload Page" buttons
- Uses semantic colors (`bg-background`, `bg-destructive`)

### Console Error Categories to Check

[Source: Common Next.js/React issues]

| Category           | Example                             | Solution                         |
| ------------------ | ----------------------------------- | -------------------------------- |
| Hydration mismatch | "Text content did not match"        | Ensure server/client consistency |
| Missing key        | "Each child should have unique key" | Add `key` prop to list items     |
| Invalid prop       | "Invalid prop `disabled` supplied"  | Check prop types                 |
| Unhandled promise  | "Unhandled promise rejection"       | Add try/catch or .catch()        |
| Next.js specific   | "next/image" warnings               | Follow Image component docs      |

### File Locations for New Loading States

[Source: architecture/7-source-tree.md]

| New File                                           | Skeleton Content                |
| -------------------------------------------------- | ------------------------------- |
| `app/(root)/products/[slug]/loading.tsx`           | Product image, details, actions |
| `app/(root)/cart/loading.tsx`                      | Cart items list, order summary  |
| `app/(root)/order/[id]/loading.tsx`                | Order info, items, totals       |
| `app/(root)/place-order/loading.tsx`               | Order review, items, address    |
| `app/(root)/user/profile/loading.tsx`              | Profile form fields             |
| `app/(root)/user/orders/loading.tsx`               | Order history table rows        |
| `app/(admin)/admin/products/loading.tsx`           | Product table rows              |
| `app/(admin)/admin/products/[id]/edit/loading.tsx` | Product form fields             |

### Integration Verification Points

[Source: docs/prd/7-epic-2-production-readiness-polish.md#story-23]

| #   | Verification                               |
| --- | ------------------------------------------ |
| IV1 | Product listing shows skeleton during load |
| IV2 | Cart updates don't cause flashing          |
| IV3 | Order pages handle loading states          |
| IV4 | Admin dashboard loads smoothly             |

---

## Testing

### Test File Location

No automated tests - manual testing only (per project testing strategy).

### Testing Standards

[Source: architecture/10-testing-strategy.md#regression-testing]

| Area                  | Verification Steps                              |
| --------------------- | ----------------------------------------------- |
| Product Browsing      | Products page loads with skeleton, then content |
| Product Detail        | Product page shows skeleton during load         |
| Cart Flow             | Cart updates smoothly without flashing          |
| Checkout Flow         | All checkout steps have loading indicators      |
| Order History         | Orders page shows skeleton, then table          |
| Admin Dashboard       | Admin pages load smoothly with skeletons        |
| Dark Mode             | Skeletons render correctly in dark mode         |
| Mobile Responsiveness | Skeletons are responsive and match content      |

### Testing Framework

Manual testing with browser DevTools (Network throttling, Console).

### Loading State Test Cases

| #     | Test Case               | Steps                                     | Expected Result                       |
| ----- | ----------------------- | ----------------------------------------- | ------------------------------------- |
| LS-1  | Products page skeleton  | Navigate to /products with slow 3G        | Grid skeleton appears, then content   |
| LS-2  | Product detail skeleton | Navigate to /products/[slug] with slow 3G | Detail skeleton appears, then content |
| LS-3  | Cart page loading       | Navigate to /cart with items              | Cart loads without layout shift       |
| LS-4  | Order detail skeleton   | Navigate to /order/[id]                   | Order skeleton appears, then content  |
| LS-5  | User profile skeleton   | Navigate to /user/profile                 | Profile form skeleton, then content   |
| LS-6  | Order history skeleton  | Navigate to /user/orders                  | Table skeleton appears, then rows     |
| LS-7  | Admin products skeleton | Navigate to /admin/products               | Table skeleton appears, then products |
| LS-8  | No console errors       | Navigate all pages with console open      | No errors in console                  |
| LS-9  | Build passes            | Run npm run build                         | Build completes successfully          |
| LS-10 | Lint passes             | Run npm run lint                          | No linting errors                     |
| LS-11 | Production mode works   | Run npm start after build                 | All pages load correctly              |
| LS-12 | Error boundary works    | Trigger an error in component             | Error UI shows with retry option      |

### Production Testing Checklist

| #   | Page/Flow             | Verified |
| --- | --------------------- | -------- |
| 1   | Home → Products       |          |
| 2   | Products filtering    |          |
| 3   | Products pagination   |          |
| 4   | Product detail page   |          |
| 5   | Add to cart           |          |
| 6   | Cart page             |          |
| 7   | Checkout: shipping    |          |
| 8   | Checkout: payment     |          |
| 9   | Checkout: place order |          |
| 10  | Order detail          |          |
| 11  | Stripe payment        |          |
| 12  | User profile          |          |
| 13  | Order history         |          |
| 14  | Admin: products list  |          |
| 15  | Admin: create product |          |
| 16  | Admin: edit product   |          |
| 17  | Dark mode (all pages) |          |
| 18  | Mobile responsive     |          |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-02-08 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent after implementation_
