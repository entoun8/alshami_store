# Story 1.10: Production Deployment

## Status

Draft

## Story

**As a** store owner,
**I want** the store deployed to production,
**so that** customers can access the live store.

## Acceptance Criteria

| #    | Criteria                                                      |
| ---- | ------------------------------------------------------------- |
| AC1  | `.env.example` documents all required variables               |
| AC2  | Deployed to Vercel                                            |
| AC3  | Custom domain configured with HTTPS                           |
| AC4  | All env vars set in Vercel                                    |
| AC5  | `NEXTAUTH_URL` and `SERVER_URL` point to production           |
| AC6  | Google OAuth URIs updated for production                      |
| AC7  | Stripe webhook configured in Dashboard                        |
| AC8  | Stripe keys switched to live mode                             |
| AC9  | Resend domain verified                                        |
| AC10 | E2E test: Browse → Cart → Checkout → Pay → Email              |

## Tasks / Subtasks

- [ ] **Task 1: Verify Pre-Deployment Readiness** (AC: 1)
  - [ ] 1.1 Verify `.env.example` contains all required variables (already exists, verify completeness)
  - [ ] 1.2 Run `npm run build` to ensure production build succeeds
  - [ ] 1.3 Run `npm run lint` to ensure no linting errors
  - [ ] 1.4 Verify all Stories 1.1-1.9 and Epic 2 are marked Done
  - [ ] 1.5 Test production build locally with `npm start`

- [ ] **Task 2: Create Vercel Project** (AC: 2)
  - [ ] 2.1 Create new Vercel project via Vercel Dashboard
  - [ ] 2.2 Connect GitHub repository to Vercel
  - [ ] 2.3 Configure build settings:
    - Build Command: `npm run build`
    - Output Directory: `.next`
    - Install Command: `npm install`
    - Framework: Next.js
  - [ ] 2.4 Verify initial deployment succeeds (without env vars, will fail at runtime - expected)

- [ ] **Task 3: Configure Custom Domain** (AC: 3)
  - [ ] 3.1 Add custom domain in Vercel project settings
  - [ ] 3.2 Configure DNS records (CNAME or A record per Vercel instructions)
  - [ ] 3.3 Wait for DNS propagation (can take up to 48 hours, usually minutes)
  - [ ] 3.4 Verify SSL certificate is auto-provisioned by Vercel
  - [ ] 3.5 Verify HTTPS works (browser shows padlock)

- [ ] **Task 4: Configure Vercel Environment Variables** (AC: 4, 5)
  - [ ] 4.1 Navigate to Vercel Project → Settings → Environment Variables
  - [ ] 4.2 Add Supabase variables:
    - `NEXT_PUBLIC_SUPABASE_URL` (Client + Server)
    - `NEXT_PUBLIC_SUPABASE_ANON_KEY` (Client + Server)
    - `SUPABASE_SERVICE_ROLE_KEY` (Server only - CRITICAL: never expose to client)
  - [ ] 4.3 Add NextAuth variables:
    - `NEXTAUTH_URL` = `https://your-domain.com` (Server)
    - `NEXTAUTH_SECRET` = strong random 32+ char secret (Server)
  - [ ] 4.4 Add Google OAuth variables:
    - `AUTH_GOOGLE_ID` (Server)
    - `AUTH_GOOGLE_SECRET` (Server)
  - [ ] 4.5 Add Stripe variables (LIVE mode):
    - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` = `pk_live_xxx` (Client + Server)
    - `STRIPE_SECRET_KEY` = `sk_live_xxx` (Server only)
    - `STRIPE_WEBHOOK_SECRET` = production webhook secret (Server only)
  - [ ] 4.6 Add Resend variables:
    - `RESEND_API_KEY` (Server only)
    - `EMAIL_FROM_ADDRESS` = `orders@your-domain.com` (Server)
  - [ ] 4.7 Add App variable:
    - `SERVER_URL` = `https://your-domain.com` (Server)
  - [ ] 4.8 Trigger redeployment after adding env vars

- [ ] **Task 5: Configure Google OAuth for Production** (AC: 6)
  - [ ] 5.1 Go to Google Cloud Console → APIs & Services → Credentials
  - [ ] 5.2 Edit the OAuth 2.0 Client ID used for this project
  - [ ] 5.3 Add production URI to "Authorized JavaScript origins": `https://your-domain.com`
  - [ ] 5.4 Add production URI to "Authorized redirect URIs": `https://your-domain.com/api/auth/callback/google`
  - [ ] 5.5 Save changes
  - [ ] 5.6 Test Google Sign-In on production

- [ ] **Task 6: Configure Stripe Webhook for Production** (AC: 7, 8)
  - [ ] 6.1 Go to Stripe Dashboard → Developers → Webhooks
  - [ ] 6.2 Click "Add endpoint"
  - [ ] 6.3 Set endpoint URL: `https://your-domain.com/api/webhooks/stripe`
  - [ ] 6.4 Select events to listen to: `payment_intent.succeeded`
  - [ ] 6.5 Create endpoint and copy the signing secret
  - [ ] 6.6 Update `STRIPE_WEBHOOK_SECRET` in Vercel with production secret
  - [ ] 6.7 Switch Stripe to LIVE mode (Dashboard toggle)
  - [ ] 6.8 Verify live keys are set in Vercel (`pk_live_`, `sk_live_`)
  - [ ] 6.9 Trigger redeployment

- [ ] **Task 7: Configure Resend Domain** (AC: 9)
  - [ ] 7.1 Go to Resend Dashboard → Domains
  - [ ] 7.2 Add your production domain (e.g., `your-domain.com`)
  - [ ] 7.3 Add DNS records as instructed by Resend (SPF, DKIM, DMARC)
  - [ ] 7.4 Wait for domain verification (can take minutes to hours)
  - [ ] 7.5 Verify domain shows as "Verified" in Resend
  - [ ] 7.6 Update `EMAIL_FROM_ADDRESS` in Vercel to use verified domain

- [ ] **Task 8: End-to-End Production Testing** (AC: 10)
  - [ ] 8.1 Visit production URL, verify site loads
  - [ ] 8.2 Test Google OAuth sign-in
  - [ ] 8.3 Browse products, verify images load from Supabase Storage
  - [ ] 8.4 Add items to cart
  - [ ] 8.5 Proceed through checkout (shipping address, payment method)
  - [ ] 8.6 Complete Stripe payment with real card (use small test product or refund after)
  - [ ] 8.7 Verify order marked as Paid in database
  - [ ] 8.8 Verify confirmation email received
  - [ ] 8.9 Check order appears in Order History
  - [ ] 8.10 Test Admin Dashboard (create/edit/delete product)
  - [ ] 8.11 Verify dark mode works on all pages
  - [ ] 8.12 Test mobile responsiveness

- [ ] **Task 9: Post-Deployment Verification**
  - [ ] 9.1 Check Vercel deployment logs for any errors
  - [ ] 9.2 Check Supabase security advisor (no ERROR-level issues)
  - [ ] 9.3 Check Stripe Dashboard for successful webhook deliveries
  - [ ] 9.4 Check Resend Dashboard for successful email deliveries
  - [ ] 9.5 Monitor for 24 hours for any runtime errors
  - [ ] 9.6 Document production URL and any notes in this story

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.7.story.md#dev-agent-record]

Epic 2 (Production Readiness & Polish) has been completed successfully:
- Story 2.1: Security & Supabase Configuration reviewed
- Story 2.2: Codebase Consistency reviewed
- Story 2.3: Loading States verified
- Story 2.4: SEO & Metadata optimized
- Story 2.5: Purchase Email Delivery fixed
- Story 2.6: Product Slug Auto-Generation implemented
- Story 2.7: Image Upload verified

All security advisors passed, build/lint pass, and the application is ready for production deployment.

### Environment Variables Reference

[Source: architecture/8-infrastructure-and-deployment-integration.md#environment-variables-configuration]

**Required Production Environment Variables:**

| Variable | Scope | Description |
|----------|-------|-------------|
| `NEXT_PUBLIC_SUPABASE_URL` | Client + Server | Supabase project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Client + Server | Supabase anon key (safe for client) |
| `SUPABASE_SERVICE_ROLE_KEY` | **Server only** | Service role key (NEVER expose to client) |
| `NEXTAUTH_URL` | Server | Production domain URL |
| `NEXTAUTH_SECRET` | Server | Strong random secret (32+ chars) |
| `AUTH_GOOGLE_ID` | Server | Google OAuth client ID |
| `AUTH_GOOGLE_SECRET` | Server | Google OAuth client secret |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Client + Server | Stripe publishable key (live mode) |
| `STRIPE_SECRET_KEY` | **Server only** | Stripe secret key (live mode) |
| `STRIPE_WEBHOOK_SECRET` | **Server only** | Stripe webhook signing secret |
| `RESEND_API_KEY` | **Server only** | Resend API key |
| `EMAIL_FROM_ADDRESS` | Server | Verified sender email address |
| `SERVER_URL` | Server | Production domain URL |

**CRITICAL:** Variables marked "Server only" must NOT be prefixed with `NEXT_PUBLIC_` and must be set with "Server" scope in Vercel.

### Vercel Deployment Configuration

[Source: architecture/8-infrastructure-and-deployment-integration.md#pipeline-integration]

**Build Configuration:**
```json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "installCommand": "npm install",
  "framework": "nextjs"
}
```

**Deployment Pipeline:**
```
GitHub Push → Vercel Build → Deploy to Production
     │              │              │
     │              │              └── Automatic SSL
     │              │                  Edge distribution
     │              │
     │              └── next build
     │                  Type checking
     │                  Linting
     │
     └── main branch trigger
```

### External Service Configuration

[Source: architecture/8-infrastructure-and-deployment-integration.md#infrastructure-changes-required]

**Google OAuth:**
1. Go to Google Cloud Console → APIs & Services → Credentials
2. Add to "Authorized JavaScript origins": `https://your-domain.com`
3. Add to "Authorized redirect URIs": `https://your-domain.com/api/auth/callback/google`

**Stripe Webhook:**
1. Stripe Dashboard → Developers → Webhooks → Add endpoint
2. Endpoint URL: `https://your-domain.com/api/webhooks/stripe`
3. Events: `payment_intent.succeeded`
4. Copy signing secret to `STRIPE_WEBHOOK_SECRET`

**Resend Domain:**
1. Resend Dashboard → Domains → Add domain
2. Add DNS records (SPF, DKIM, DMARC)
3. Wait for verification
4. Use verified domain in `EMAIL_FROM_ADDRESS`

### File Locations

[Source: architecture/7-source-tree.md]

| File | Purpose |
|------|---------|
| `.env.example` | Documents all required environment variables |
| `next.config.ts` | Next.js configuration (already has Supabase image domain) |
| `app/api/webhooks/stripe/route.ts` | Stripe webhook handler |
| `lib/email.ts` | Resend email service |
| `lib/auth.ts` | NextAuth configuration |
| `lib/supabase.ts` | Supabase client (includes admin client) |

### Rollback Strategy

[Source: architecture/8-infrastructure-and-deployment-integration.md#rollback-strategy]

| Scenario | Rollback Method |
|----------|-----------------|
| Deployment failure | Vercel automatic rollback to previous deployment |
| Runtime errors | Vercel instant rollback via dashboard (one-click) |
| Database issues | Manual SQL rollback scripts |
| Feature issues | Revert Git commit, push triggers new deployment |

### Risk Mitigation

[Source: architecture/8-infrastructure-and-deployment-integration.md#risk-mitigation]

| Risk | Mitigation |
|------|------------|
| Google OAuth redirect mismatch | Test OAuth flow immediately after deployment |
| Stripe webhook fails | Monitor Stripe Dashboard for failed webhooks |
| Email delivery issues | Check Resend Dashboard for delivery logs |
| Service role key exposure | Verify in Vercel that it's server-only scope |

---

## Testing

### Test File Location

No automated tests - manual E2E testing per project testing strategy.

### Testing Standards

[Source: architecture/10-testing-strategy.md#story-110-production-deployment-test-cases]

| #      | Test Case                    | Steps                                  | Expected Result                  |
| ------ | ---------------------------- | -------------------------------------- | -------------------------------- |
| PROD-1 | Site loads on production URL | Visit production domain                | Home page loads                  |
| PROD-2 | HTTPS works                  | Check browser padlock                  | Valid SSL certificate            |
| PROD-3 | Google OAuth works           | Click sign in, complete OAuth          | Successfully logged in           |
| PROD-4 | Full purchase flow           | Add to cart → Checkout → Pay           | Order created, email received    |
| PROD-5 | Admin dashboard works        | Log in as admin, CRUD product          | All operations succeed           |

### Full User Journey Test

[Source: architecture/10-testing-strategy.md#integration-tests-manual]

```
1. Visit site (anonymous)
2. Browse products
3. Search for a product
4. Add items to cart
5. Sign in with Google
6. Verify cart items preserved
7. Proceed to checkout
8. Enter shipping address
9. Select payment method
10. Review and place order
11. Complete Stripe payment
12. Verify order status updates to "Paid"
13. Check email for confirmation
14. Visit order history
15. Verify order appears in history
```

### Admin Journey Test

```
1. Sign in as admin user
2. Navigate to /admin/products
3. Create new product with image
4. Verify product appears on public site
5. Edit product details
6. Verify changes reflected
7. Delete product
8. Verify product removed from public site
```

### Testing Framework

Manual testing with browser DevTools verification.

---

## Integration Verification

| #   | Verification                                      |
| --- | ------------------------------------------------- |
| IV1 | All pages load on production domain               |
| IV2 | Google OAuth works                                |
| IV3 | Stripe payment completes with live keys           |
| IV4 | Webhook updates order status                      |
| IV5 | Email received                                    |
| IV6 | Admin dashboard functional                        |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-02-12 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

---

## QA Results

_To be filled by QA Agent after implementation_
