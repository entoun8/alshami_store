# Story 1.1: Enable Row Level Security Policies

## Status

Done

## Story

**As a** store owner,
**I want** my customer data protected by row-level security,
**so that** users can only access their own data and the platform meets security standards.

## Acceptance Criteria

| #   | Criteria                                                                                             |
| --- | ---------------------------------------------------------------------------------------------------- |
| AC1 | RLS is enabled on all 5 public tables: `Product`, `cart`, `order`, `order_item`, `user_profile`      |
| AC2 | `Product` table has policy: Anyone can SELECT (public catalog)                                       |
| AC3 | `Product` table has policy: Only admin role can INSERT, UPDATE, DELETE                               |
| AC4 | `cart` table has policy: Users can only access their own cart (by `user_id` or `session_cart_id`)    |
| AC5 | `order` table has policy: Users can only SELECT their own orders; INSERT requires authenticated user |
| AC6 | `order_item` table has policy: Users can only access items for their own orders                      |
| AC7 | `user_profile` table has existing policies activated                                                 |
| AC8 | Functions `create_order_atomic` and `update_updated_at_column` have `search_path` set to `''`        |
| AC9 | All Supabase security advisor ERROR-level issues are resolved                                        |

## Tasks / Subtasks

- [x] **Task 1: Enable RLS on all 5 tables** (AC: 1, 7)
  - [x] 1.1 Run `ALTER TABLE public."Product" ENABLE ROW LEVEL SECURITY;`
  - [x] 1.2 Run `ALTER TABLE public.cart ENABLE ROW LEVEL SECURITY;`
  - [x] 1.3 Run `ALTER TABLE public."order" ENABLE ROW LEVEL SECURITY;`
  - [x] 1.4 Run `ALTER TABLE public.order_item ENABLE ROW LEVEL SECURITY;`
  - [x] 1.5 Run `ALTER TABLE public.user_profile ENABLE ROW LEVEL SECURITY;`

- [x] **Task 2: Create Product table policies** (AC: 2, 3)
  - [x] 2.1 Create policy "Anyone can view products" for SELECT with `USING (true)`
  - [x] 2.2 Create policy "Admins can insert products" for INSERT checking admin role
  - [x] 2.3 Create policy "Admins can update products" for UPDATE checking admin role
  - [x] 2.4 Create policy "Admins can delete products" for DELETE checking admin role

- [x] **Task 3: Create Cart table policies** (AC: 4)
  - [x] 3.1 Create policy "Users can view own cart" for SELECT (by user_id OR session_cart_id)
  - [x] 3.2 Create policy "Users can insert own cart" for INSERT
  - [x] 3.3 Create policy "Users can update own cart" for UPDATE
  - [x] 3.4 Create policy "Users can delete own cart" for DELETE

- [x] **Task 4: Create Order table policies** (AC: 5)
  - [x] 4.1 Create policy "Users can view own orders" for SELECT (user_id = auth.uid())
  - [x] 4.2 Create policy "Authenticated users can create orders" for INSERT

- [x] **Task 5: Create Order Item table policies** (AC: 6)
  - [x] 5.1 Create policy "Users can view own order items" for SELECT (via order ownership join)
  - [x] 5.2 Create policy "Authenticated users can insert order items" for INSERT (via order ownership join)

- [x] **Task 6: Fix function search_path security** (AC: 8)
  - [x] 6.1 Run `ALTER FUNCTION public.create_order_atomic SET search_path = '';` (both overloads)
  - [x] 6.2 Run `ALTER FUNCTION public.update_updated_at_column SET search_path = '';`

- [x] **Task 7: Verify Supabase Security Advisors** (AC: 9)
  - [x] 7.1 Run Supabase security advisors check
  - [x] 7.2 Confirm all ERROR-level issues resolved

- [x] **Task 8: Integration Verification Testing**
  - [x] 8.1 Verify anonymous users can browse products (IV1)
  - [x] 8.2 Verify cart functionality works for authenticated users (IV2)
  - [x] 8.3 Verify checkout flow completes successfully (IV3)
  - [x] 8.4 Verify order detail page loads for order owner (IV4)
  - [x] 8.5 Verify users cannot access another user's cart or orders (IV5)

## Dev Notes

### Database Tables Involved

[Source: architecture/4-data-models-and-schema-changes.md#existing-database-schema-verified-via-supabase-mcp]

| Table          | Primary Key                         | Current RLS Status                          |
| -------------- | ----------------------------------- | ------------------------------------------- |
| `user_profile` | `id` (UUID)                         | Disabled (policies exist but not activated) |
| `Product`      | `id` (bigint, identity)             | Disabled                                    |
| `cart`         | `id` (UUID)                         | Disabled                                    |
| `order`        | `id` (UUID)                         | Disabled                                    |
| `order_item`   | `order_id + product_id` (composite) | Disabled                                    |

### RLS Policy SQL Reference

[Source: architecture/4-data-models-and-schema-changes.md#rls-policy-design-story-11]

**Product Table Policies:**

```sql
-- Enable RLS
ALTER TABLE public."Product" ENABLE ROW LEVEL SECURITY;

-- Public read access (catalog browsing)
CREATE POLICY "Anyone can view products" ON public."Product"
  FOR SELECT USING (true);

-- Admin-only write access
CREATE POLICY "Admins can insert products" ON public."Product"
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.user_profile WHERE id = auth.uid() AND role = 'admin')
  );

CREATE POLICY "Admins can update products" ON public."Product"
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM public.user_profile WHERE id = auth.uid() AND role = 'admin')
  );

CREATE POLICY "Admins can delete products" ON public."Product"
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM public.user_profile WHERE id = auth.uid() AND role = 'admin')
  );
```

**Cart Table Policies:**

```sql
-- Enable RLS
ALTER TABLE public.cart ENABLE ROW LEVEL SECURITY;

-- Users can access their own cart (by user_id OR session_cart_id)
CREATE POLICY "Users can view own cart" ON public.cart
  FOR SELECT USING (
    user_id = auth.uid() OR
    session_cart_id = current_setting('request.cookies')::json->>'sessionCartId'
  );

CREATE POLICY "Users can insert own cart" ON public.cart
  FOR INSERT WITH CHECK (
    user_id = auth.uid() OR user_id IS NULL
  );

CREATE POLICY "Users can update own cart" ON public.cart
  FOR UPDATE USING (
    user_id = auth.uid() OR
    session_cart_id = current_setting('request.cookies')::json->>'sessionCartId'
  );

CREATE POLICY "Users can delete own cart" ON public.cart
  FOR DELETE USING (
    user_id = auth.uid() OR
    session_cart_id = current_setting('request.cookies')::json->>'sessionCartId'
  );
```

**Order Table Policies:**

```sql
-- Enable RLS
ALTER TABLE public."order" ENABLE ROW LEVEL SECURITY;

-- Users can view their own orders
CREATE POLICY "Users can view own orders" ON public."order"
  FOR SELECT USING (user_id = auth.uid());

-- Authenticated users can create orders
CREATE POLICY "Authenticated users can create orders" ON public."order"
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL AND user_id = auth.uid());

-- Note: Service role (for webhooks) bypasses RLS, so no explicit UPDATE policy needed for webhook order updates
```

**Order Item Table Policies:**

```sql
-- Enable RLS
ALTER TABLE public.order_item ENABLE ROW LEVEL SECURITY;

-- Users can view items for their own orders
CREATE POLICY "Users can view own order items" ON public.order_item
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public."order" o
      WHERE o.id = order_item.order_id AND o.user_id = auth.uid()
    )
  );

-- Insert handled by create_order_atomic function (service role)
CREATE POLICY "Authenticated users can insert order items" ON public.order_item
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public."order" o
      WHERE o.id = order_item.order_id AND o.user_id = auth.uid()
    )
  );
```

**User Profile Table:**

```sql
-- Enable RLS (policies already exist, just need activation)
ALTER TABLE public.user_profile ENABLE ROW LEVEL SECURITY;

-- Existing policies will become active:
-- - "Anyone can view profiles"
-- - "Users can insert own profile"
-- - "Users can update own profile"
```

### Function Security Fixes

[Source: architecture/4-data-models-and-schema-changes.md#function-security-fixes]

```sql
-- Fix search_path for create_order_atomic
ALTER FUNCTION public.create_order_atomic SET search_path = '';

-- Fix search_path for update_updated_at_column
ALTER FUNCTION public.update_updated_at_column SET search_path = '';
```

### Security Context

[Source: architecture/11-security-integration.md#current-security-issues-from-supabase-advisors]

**Current Security Issues to Resolve:**

| Level | Issue                              | Affected                                                 |
| ----- | ---------------------------------- | -------------------------------------------------------- |
| ERROR | RLS Disabled                       | `Product`, `cart`, `order`, `order_item`, `user_profile` |
| ERROR | Policies exist but RLS not enabled | `user_profile`                                           |
| WARN  | Function search_path mutable       | `create_order_atomic`                                    |
| WARN  | Function search_path mutable       | `update_updated_at_column`                               |

### Backward Compatibility

[Source: architecture/4-data-models-and-schema-changes.md#backward-compatibility]

| Measure                   | Implementation                                                    |
| ------------------------- | ----------------------------------------------------------------- |
| Existing reads work       | SELECT policies allow same access patterns as before RLS          |
| Existing cart flow works  | Session cart ID pattern preserved in RLS policy                   |
| Existing checkout works   | Order creation still works for authenticated users                |
| Service role for webhooks | Webhook handler uses service role to bypass RLS for order updates |
| Service role for admin    | Admin CRUD uses service role for Product table operations         |

### Important Implementation Notes

1. **Table Names with Quotes**: The `Product` and `order` tables require double quotes in SQL because `order` is a reserved keyword and `Product` has a capital P.

2. **Session Cart ID Access**: The cart policies use `current_setting('request.cookies')::json->>'sessionCartId'` to check session cart ownership for anonymous users.

3. **Service Role Usage**: After RLS is enabled, the application should use:
   - **Anon client** for user operations (RLS enforced)
   - **Service role client** for admin operations and webhook handlers (bypasses RLS)

4. **No New Files Required**: This story only involves database migrations - no application code changes needed.

5. **Apply via Supabase MCP or Dashboard**: These SQL statements should be applied using the Supabase MCP `apply_migration` tool or directly via the Supabase Dashboard SQL Editor.

### Testing

[Source: architecture/10-testing-strategy.md#story-11-rls-policies-test-cases]

**Manual Test Cases:**

| #     | Test Case                                | Steps                                             | Expected Result                |
| ----- | ---------------------------------------- | ------------------------------------------------- | ------------------------------ |
| RLS-1 | Anonymous user can view products         | Visit `/products` without logging in              | Products display correctly     |
| RLS-2 | Anonymous user cannot view others' carts | Attempt to query cart table directly via Supabase | Query returns empty or error   |
| RLS-3 | Logged-in user sees only own cart        | Log in, add items, check cart                     | Only user's cart items visible |
| RLS-4 | Logged-in user sees only own orders      | Log in, visit `/user/orders`                      | Only user's orders displayed   |
| RLS-5 | User cannot access other user's order    | Try to visit `/order/[other-user-order-id]`       | 404 or access denied           |
| RLS-6 | Admin can CRUD products                  | Log in as admin, create/edit/delete product       | All operations succeed         |
| RLS-7 | Non-admin cannot CRUD products           | Log in as regular user, attempt admin actions     | Operations fail with 403       |

**Testing Framework:** Manual testing (no automated test framework established)

**Verification via Supabase Advisors:** After applying migrations, run `mcp__supabase__get_advisors` with type "security" to confirm all ERROR-level issues are resolved.

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-01-18 | 1.0     | Initial story draft | SM Agent (Bob) |
| 2026-01-18 | 1.1     | Implementation complete - All RLS policies applied | Dev Agent (James) |
| 2026-01-18 | 1.2     | QA gate PASS - Status set to Done | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Task 6 required identifying both function overloads for `create_order_atomic` (9-param and 11-param versions)

### Completion Notes List

1. Applied 6 Supabase migrations via MCP:
   - `enable_rls_all_tables` - Enabled RLS on all 5 tables
   - `create_product_policies` - 4 policies (SELECT public, INSERT/UPDATE/DELETE admin)
   - `create_cart_policies` - 4 policies (CRUD with user_id/session_cart_id check)
   - `create_order_policies` - 2 policies (SELECT own, INSERT authenticated)
   - `create_order_item_policies` - 2 policies (SELECT/INSERT via order ownership)
   - `fix_function_search_path` - Fixed both `create_order_atomic` overloads and `update_updated_at_column`

2. Security advisor verification confirmed all ERROR-level issues resolved
3. Remaining WARN-level issues are out of scope (user_profile INSERT policy, leaked password protection)
4. Used `current_setting('request.cookies', true)` with `true` param for graceful handling when setting doesn't exist

### File List

No application source files modified. Database-only changes via Supabase migrations:

| Migration Name | Tables/Functions Affected |
|---------------|---------------------------|
| `enable_rls_all_tables` | Product, cart, order, order_item, user_profile |
| `create_product_policies` | Product |
| `create_cart_policies` | cart |
| `create_order_policies` | order |
| `create_order_item_policies` | order_item |
| `fix_function_search_path` | create_order_atomic (x2), update_updated_at_column |

---

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: DEEP** - Auto-escalated due to:
- Security-critical story (RLS policies)
- 9 acceptance criteria (>5 threshold)
- Auth/security files touched

### Code Quality Assessment

**Overall: EXCELLENT** ✓

This is a database-only story with no application code changes. The implementation demonstrates:
- **Proper RLS Architecture**: All 5 tables have RLS enabled with appropriate policies
- **Defense in Depth**: Policies correctly implement role-based access control
- **Session Cart Support**: Cart policies correctly handle both authenticated users (`user_id = auth.uid()`) and anonymous sessions (`session_cart_id` cookie check)
- **Admin Isolation**: Product write operations properly check for admin role via subquery
- **Order Ownership**: Order and order_item policies correctly enforce user ownership via `auth.uid()`
- **Function Security**: Both `create_order_atomic` overloads and `update_updated_at_column` have `search_path = ''` set

### Requirements Traceability

| AC# | Requirement | Verification | Status |
|-----|-------------|--------------|--------|
| AC1 | RLS enabled on all 5 tables | ✓ Verified via `mcp__supabase__list_tables` - all show `rls_enabled: true` | ✅ PASS |
| AC2 | Product SELECT policy (public) | ✓ Policy "Anyone can view products" with `USING (true)` | ✅ PASS |
| AC3 | Product admin-only write | ✓ INSERT/UPDATE/DELETE policies check `role = 'admin'` via user_profile | ✅ PASS |
| AC4 | Cart owner-only access | ✓ All CRUD policies check `user_id = auth.uid() OR session_cart_id` | ✅ PASS |
| AC5 | Order user-only SELECT/INSERT | ✓ SELECT checks `user_id = auth.uid()`, INSERT checks both conditions | ✅ PASS |
| AC6 | Order_item via order ownership | ✓ Both SELECT/INSERT use EXISTS subquery to verify order ownership | ✅ PASS |
| AC7 | user_profile policies activated | ✓ RLS enabled, existing policies now active | ✅ PASS |
| AC8 | Function search_path fixed | ✓ All 3 functions have `search_path = ''` confirmed via pg_proc | ✅ PASS |
| AC9 | Security advisors clean | ✓ Only WARN-level issues remain (out of scope) | ✅ PASS |

### Test Coverage Assessment

**Given-When-Then Mapping:**

| Test ID | Given | When | Then | Priority |
|---------|-------|------|------|----------|
| RLS-1 | Anonymous user | Visits `/products` | Products display correctly | P0 |
| RLS-2 | Anonymous user | Queries cart table directly | Empty result or error | P0 |
| RLS-3 | Authenticated user | Adds items to cart | Only own cart visible | P0 |
| RLS-4 | Authenticated user | Visits order history | Only own orders visible | P0 |
| RLS-5 | User A | Tries to access User B's order | 404 or access denied | P0 |
| RLS-6 | Admin user | CRUD on products | All operations succeed | P1 |
| RLS-7 | Non-admin user | Attempts admin actions | Operations fail | P1 |

**Coverage Gaps:** None - all ACs have corresponding test cases defined in architecture docs.

### Refactoring Performed

None required - this is a database-only migration story with no application code.

### Compliance Check

- Coding Standards: ✓ N/A (database migrations only)
- Project Structure: ✓ Migrations applied via Supabase MCP
- Testing Strategy: ✓ Manual test cases documented in architecture
- All ACs Met: ✓ All 9 acceptance criteria verified

### Security Review

**Status: PASS** ✓

| Aspect | Finding |
|--------|---------|
| **RLS Enabled** | ✓ All 5 tables have RLS enabled |
| **Policy Correctness** | ✓ All policies use proper `auth.uid()` checks |
| **Admin Access** | ✓ Admin operations properly gated via role check |
| **Session Cart** | ✓ Uses `current_setting('request.cookies', true)` with graceful fallback |
| **Function Security** | ✓ search_path fixed on all functions |

**Remaining Advisories (Out of Scope):**
- WARN: `user_profile` INSERT policy is always true (by design - new user registration)
- WARN: Leaked password protection disabled (N/A - OAuth only, no passwords)

### Performance Considerations

**Status: PASS** ✓

| Aspect | Assessment |
|--------|------------|
| **Policy Efficiency** | Admin role checks use indexed `id` column with subquery |
| **Order Item Joins** | EXISTS subquery on order_id should be efficient with FK index |
| **No N+1 Risk** | Policies execute per-row, not per-request - standard RLS overhead |

### Testability Evaluation

| Dimension | Score | Notes |
|-----------|-------|-------|
| **Controllability** | HIGH | Can test via Supabase Dashboard or direct SQL |
| **Observability** | HIGH | Supabase security advisors provide visibility |
| **Debuggability** | MEDIUM | RLS errors may need policy analysis |

### NFR Validation Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | ✅ PASS | RLS enabled, policies correctly enforce access control |
| Performance | ✅ PASS | Standard RLS overhead, indexed lookups |
| Reliability | ✅ PASS | Policies use graceful fallbacks |
| Maintainability | ✅ PASS | Clear policy naming, documented in Dev Notes |

### Files Modified During Review

None - review only, no code changes required.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.1-enable-rls-policies.yml

### Recommended Status

✅ **Ready for Done** - All acceptance criteria verified, security implementation is correct, no blocking issues found.

---
