# Story 2.2: Codebase Consistency Review

## Status

Done

## Story

**As a** developer,
**I want** the codebase reviewed for consistency,
**so that** architecture and patterns are uniform across the project.

## Acceptance Criteria

| #   | Criteria                                                                    |
| --- | --------------------------------------------------------------------------- |
| AC1 | Folder structure follows established architecture                           |
| AC2 | All pages use `.wrapper` class for content containers                       |
| AC3 | All colors use semantic CSS variables (no arbitrary Tailwind colors)        |
| AC4 | Typography uses established utility classes (h1-bold, h2-bold, h3-bold)     |
| AC5 | All forms use React Hook Form + Zod + useTransition pattern                 |
| AC6 | Server Components vs Client Components used appropriately                   |
| AC7 | Data fetching follows data-service.ts (reads) / actions.ts (writes) pattern |
| AC8 | Any inconsistencies documented and corrected                                |

## Tasks / Subtasks

- [ ] **Task 1: Audit Folder Structure** (AC: 1)
  - [ ] 1.1 Verify `app/` follows route group patterns: `(root)/`, `(auth)/`, `(admin)/`
  - [ ] 1.2 Verify `components/` follows feature-based grouping: `ui/`, `authentication/`, `cart/`, `checkout/`, `layout/`, `products/`, `providers/`, `search/`, `user/`, `admin/`
  - [ ] 1.3 Verify `lib/` contains: `constants.ts`, `utils.ts`, `supabase.ts`, `auth.ts`, `data-service.ts`, `actions.ts`, `validators.ts`, `email.ts`
  - [ ] 1.4 Document any files that are misplaced or not following conventions
  - [ ] 1.5 Move any misplaced files to correct locations (if found)

- [ ] **Task 2: Audit `.wrapper` Class Usage** (AC: 2)
  - [ ] 2.1 List all page files in `app/(root)/` and `app/(admin)/`
  - [ ] 2.2 Check each page uses `<main className="wrapper">` or `<div className="wrapper">` for content container
  - [ ] 2.3 Document pages missing `.wrapper` class
  - [ ] 2.4 Add `.wrapper` class to pages where missing

- [ ] **Task 3: Audit Color System Compliance** (AC: 3)
  - [ ] 3.1 Search codebase for arbitrary Tailwind color classes: `bg-blue-*`, `bg-red-*`, `bg-green-*`, `bg-gray-*`, `text-blue-*`, `text-red-*`, `text-green-*`, `text-gray-*`, `border-blue-*`, `border-red-*`, `border-green-*`, `border-gray-*`
  - [ ] 3.2 For each violation, identify the semantic CSS variable equivalent
  - [ ] 3.3 Replace arbitrary colors with semantic variables:
    - `bg-white` / `bg-gray-*` → `bg-background` or `bg-card` or `bg-muted`
    - `text-gray-*` → `text-foreground` or `text-muted-foreground`
    - `border-gray-*` → `border-border` or `border-input`
    - `bg-blue-*` / primary colors → `bg-primary`
    - `bg-red-*` / error colors → `bg-destructive`
  - [ ] 3.4 Verify all fixes work in both light and dark mode

- [ ] **Task 4: Audit Typography Classes** (AC: 4)
  - [ ] 4.1 Search for inline typography styling: `text-3xl`, `text-4xl`, `text-2xl` combined with `font-bold`
  - [ ] 4.2 Replace with utility classes where appropriate:
    - Main titles → `h1-bold`
    - Section headers → `h2-bold`
    - Subsection headers → `h3-bold`
  - [ ] 4.3 Document any typography that intentionally differs from the pattern (with justification)

- [ ] **Task 5: Audit Form Patterns** (AC: 5)
  - [ ] 5.1 List all form components in codebase
  - [ ] 5.2 Verify each form uses:
    - React Hook Form (`useForm`)
    - Zod resolver (`zodResolver`)
    - `useTransition` for pending state
    - Sonner toast for feedback (`toast.success` / `toast.error`)
  - [ ] 5.3 Document forms not following the pattern
  - [ ] 5.4 Update non-compliant forms to follow standard pattern

- [ ] **Task 6: Audit Server vs Client Components** (AC: 6)
  - [ ] 6.1 Review all files with `"use client"` directive
  - [ ] 6.2 Verify `"use client"` is only used when needed:
    - Event handlers (onClick, onChange, onSubmit)
    - React hooks (useState, useEffect, useTransition)
    - Browser APIs
    - Third-party client libraries
  - [ ] 6.3 Identify any components that could be Server Components but are marked as Client
  - [ ] 6.4 Refactor unnecessary Client Components to Server Components (where safe)

- [ ] **Task 7: Audit Data Fetching Patterns** (AC: 7)
  - [ ] 7.1 Verify all read operations use functions from `lib/data-service.ts`
  - [ ] 7.2 Verify all write operations (CREATE/UPDATE/DELETE) use Server Actions from `lib/actions.ts`
  - [ ] 7.3 Check that no page components directly query Supabase
  - [ ] 7.4 Verify Server Actions follow the standard pattern:
    - Input validation with Zod
    - Authentication/authorization check
    - Database operation
    - Path revalidation
    - Return `{ success: boolean, message: string }`
  - [ ] 7.5 Document and fix any violations

- [ ] **Task 8: Document and Summarize Findings** (AC: 8)
  - [ ] 8.1 Create summary of all inconsistencies found
  - [ ] 8.2 Track all corrections made with before/after
  - [ ] 8.3 Update Dev Notes with findings and resolutions

- [ ] **Task 9: Integration Verification** (IV: 1-3)
  - [ ] 9.1 Run `npm run build` to verify no build errors after changes
  - [ ] 9.2 Run `npm run lint` to verify no linting errors
  - [ ] 9.3 Test all modified pages render correctly
  - [ ] 9.4 Verify dark mode works on all pages
  - [ ] 9.5 Verify mobile responsiveness on modified pages

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.7.story.md#dev-agent-record]

Story 2.7 (Image Upload Verification) confirmed the build and lint pass. The codebase is stable. This story focuses on reviewing consistency across all files, not just individual features.

Key insights from completed stories:

- Forms follow React Hook Form + Zod + useTransition pattern
- Server Actions return `{ success: boolean, message: string }`
- ImageUpload, AdminProductForm, UserProfileForm all follow consistent patterns
- All Supabase operations use appropriate clients (anon vs admin)

### Folder Structure Reference

[Source: architecture/7-source-tree.md]

**Expected Project Structure:**

```
app/
├── (auth)/              # Auth route group
│   └── sign-in/
├── (root)/              # Main pages route group
│   ├── layout.tsx
│   ├── page.tsx
│   ├── products/
│   ├── cart/
│   ├── shipping-address/
│   ├── payment-method/
│   ├── place-order/
│   ├── order/[id]/
│   ├── user/profile/
│   ├── user/orders/
│   ├── about/
│   └── contact/
├── (admin)/             # Admin route group
│   ├── layout.tsx
│   └── admin/products/
├── api/
│   ├── auth/[...nextauth]/
│   └── webhooks/stripe/
├── layout.tsx
├── globals.css
├── error.tsx
└── not-found.tsx

components/
├── ui/                  # shadcn/ui components (auto-installed)
├── authentication/      # SignInButton, SignOutButton, UserMenu
├── cart/                # AddToCart, CartView, CartItem, CartIcon, OrderSummary
├── checkout/            # CheckoutSteps, ShippingAddressForm, PaymentMethodForm, etc.
├── layout/              # Header, Footer, Logo, ThemeToggle
├── products/            # ProductCard, ProductList, CategoryFilter, etc.
├── providers/           # ThemeProvider
├── search/              # SearchCommand
├── user/                # UserProfileForm, OrderHistoryList
└── admin/               # AdminProductTable, AdminProductForm, ImageUpload, etc.

lib/
├── constants.ts         # App constants
├── utils.ts             # Utility functions (cn, formatNumberWithDecimal)
├── supabase.ts          # Supabase client (anon + admin)
├── auth.ts              # NextAuth configuration
├── data-service.ts      # Database READ operations
├── actions.ts           # Server Actions (CREATE/UPDATE/DELETE)
├── validators.ts        # Zod validation schemas
└── email.ts             # Resend email service
```

### UI Standards Reference

[Source: architecture/9-coding-standards.md#ui-development-standards-from-claudemd]

**1. Color System - Semantic CSS Variables ONLY:**

| Avoid (Arbitrary)           | Use Instead (Semantic)                     |
| --------------------------- | ------------------------------------------ |
| `bg-white`, `bg-gray-*`     | `bg-background`, `bg-card`, `bg-muted`     |
| `text-black`, `text-gray-*` | `text-foreground`, `text-muted-foreground` |
| `border-gray-*`             | `border-border`, `border-input`            |
| `bg-blue-*`, primary        | `bg-primary`, `text-primary-foreground`    |
| `bg-red-*`, destructive     | `bg-destructive`                           |
| `bg-green-*`, success       | `bg-accent` or custom variable             |

**2. Layout - `.wrapper` Class:**

```tsx
// ✅ CORRECT
<main className="wrapper">
  <h1 className="h1-bold">Page Title</h1>
  {/* content */}
</main>

// ❌ INCORRECT
<div className="max-w-6xl mx-auto px-4">
  {/* content */}
</div>
```

**3. Typography - Predefined Classes:**

| Class     | Definition                       | Usage              |
| --------- | -------------------------------- | ------------------ |
| `h1-bold` | `font-bold text-3xl lg:text-4xl` | Main page title    |
| `h2-bold` | `font-bold text-2xl lg:text-3xl` | Section headers    |
| `h3-bold` | `font-bold text-xl lg:text-2xl`  | Subsection headers |

### Form Pattern Reference

[Source: architecture/9-coding-standards.md#form-handling-pattern]

**Standard Form Pattern:**

```tsx
"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useTransition } from "react";
import { toast } from "sonner";

export function MyForm({ defaultValues }) {
  const [isPending, startTransition] = useTransition();

  const form = useForm({
    resolver: zodResolver(schema),
    defaultValues,
  });

  const onSubmit = (data) => {
    startTransition(async () => {
      const result = await serverAction(data);
      if (result.success) {
        toast.success(result.message);
      } else {
        toast.error(result.message);
      }
    });
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        {/* Form fields using shadcn Form components */}
        <Button type="submit" disabled={isPending}>
          {isPending ? "Saving..." : "Save"}
        </Button>
      </form>
    </Form>
  );
}
```

### Server Action Pattern Reference

[Source: architecture/9-coding-standards.md#server-actions-pattern]

**Standard Server Action Pattern:**

```tsx
"use server";

import { z } from "zod";
import { revalidatePath } from "next/cache";

export async function myAction(
  data: z.infer<typeof schema>,
): Promise<{ success: boolean; message: string }> {
  try {
    // 1. Validate input
    const validated = schema.parse(data);

    // 2. Check authentication/authorization
    const session = await auth();
    if (!session?.user) {
      return { success: false, message: "Unauthorized" };
    }

    // 3. Perform database operation
    const { error } = await supabase.from("table").insert(validated);
    if (error) throw error;

    // 4. Revalidate affected paths
    revalidatePath("/affected-path");

    // 5. Return success
    return { success: true, message: "Success message" };
  } catch (error) {
    return { success: false, message: formatError(error) };
  }
}
```

### Server vs Client Component Guidelines

[Source: architecture/9-coding-standards.md#server-components-vs-client-components]

**Use `"use client"` ONLY when:**

- Event handlers (onClick, onChange, onSubmit)
- React hooks (useState, useEffect, useTransition)
- Browser APIs (localStorage, window)
- Third-party client libraries (Stripe Elements)

**Default to Server Components for:**

- Pages that fetch data
- Components that only render static content
- Components that pass data to child client components

### Audit Search Patterns

**Color violations to search for:**

```
bg-white|bg-black|bg-gray-|bg-slate-|bg-blue-|bg-red-|bg-green-|bg-yellow-|bg-orange-
text-white|text-black|text-gray-|text-slate-|text-blue-|text-red-|text-green-
border-white|border-black|border-gray-|border-slate-
```

**Typography violations to search for:**

```
text-3xl font-bold|text-4xl font-bold|text-2xl font-bold|text-xl font-bold
```

**Files to focus on:**

- All `page.tsx` files
- All component files in `components/`
- Skip `components/ui/` (shadcn auto-generated)

### Integration Verification Points

[Source: docs/prd/7-epic-2-production-readiness-polish.md#story-22]

| #   | Verification                                     |
| --- | ------------------------------------------------ |
| IV1 | All pages render correctly after any corrections |
| IV2 | Dark mode works on all pages                     |
| IV3 | Mobile responsiveness maintained                 |

---

## Testing

### Test File Location

No automated tests - manual testing only (per project testing strategy).

### Testing Standards

[Source: architecture/10-testing-strategy.md#regression-testing]

| Area                  | Verification Steps                                     |
| --------------------- | ------------------------------------------------------ |
| Product Browsing      | Products page loads, filtering works, pagination works |
| Cart Flow             | Add/remove/update items, cart persists                 |
| Checkout Flow         | All 3 steps work, order created                        |
| Order Detail          | Order page loads with items and totals                 |
| Authentication        | Sign in/out works, session persists                    |
| Dark Mode             | Toggle works, all pages render correctly               |
| Mobile Responsiveness | Test on mobile viewport, navigation works              |
| Admin Dashboard       | Product CRUD operations work                           |

### Testing Framework

Manual testing with browser DevTools inspection.

### Consistency Verification Tests

| #   | Test Case                 | Steps                                     | Expected Result                       |
| --- | ------------------------- | ----------------------------------------- | ------------------------------------- |
| C-1 | Pages use .wrapper        | Inspect page HTML structure               | `.wrapper` class present on container |
| C-2 | No arbitrary colors       | Search for `bg-gray-`, `text-gray-`, etc. | No matches in component files         |
| C-3 | Typography uses utilities | Search for inline `text-3xl font-bold`    | Use `h1-bold` instead                 |
| C-4 | Forms follow pattern      | Review form components                    | RHF + Zod + useTransition used        |
| C-5 | Dark mode works           | Toggle dark mode, check all pages         | All pages display correctly           |
| C-6 | Build passes              | Run `npm run build`                       | No errors                             |
| C-7 | Lint passes               | Run `npm run lint`                        | No errors                             |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-02-08 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent after implementation_
