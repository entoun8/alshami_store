# Story 1.9: Image Migration to Supabase Storage

## Status

Done

## Story

**As a** store owner,
**I want** product images in Supabase Storage,
**so that** I can upload images via admin dashboard.

## Acceptance Criteria

| #   | Criteria                                                  |
| --- | --------------------------------------------------------- |
| AC1 | Supabase Storage bucket `products` created (public read)  |
| AC2 | Existing images migrated from `/public/images/`           |
| AC3 | `Product.image` URLs updated to Supabase URLs             |
| AC4 | Admin form includes image upload                          |
| AC5 | Upload validates type (jpg, png, webp) and size (max 2MB) |
| AC6 | Unique filenames prevent conflicts                        |
| AC7 | Image preview in admin form                               |
| AC8 | `/public/images/` can be removed after verification       |

## Tasks / Subtasks

- [x] **Task 1: Create Supabase Storage bucket** (AC: 1)
  - [x] 1.1 Create `products` bucket in Supabase Storage via SQL migration or Dashboard
  - [x] 1.2 Set bucket to public (public read access)
  - [x] 1.3 Create RLS policy for public read on `storage.objects` where `bucket_id = 'products'`
  - [x] 1.4 Create RLS policy for admin-only INSERT on `storage.objects`
  - [x] 1.5 Create RLS policy for admin-only DELETE on `storage.objects`
  - [x] 1.6 Verify bucket is accessible and policies work

- [x] **Task 2: Create uploadProductImage Server Action** (AC: 5, 6)
  - [x] 2.1 Add `uploadProductImage` function to `lib/actions.ts`
  - [x] 2.2 Verify admin role from session before upload
  - [x] 2.3 Extract file from FormData
  - [x] 2.4 Validate file type (jpg, png, webp only) using MIME type check
  - [x] 2.5 Validate file size (max 2MB)
  - [x] 2.6 Generate unique filename using UUID + original extension
  - [x] 2.7 Upload to `products` bucket via `supabaseAdmin.storage`
  - [x] 2.8 Return public URL on success
  - [x] 2.9 Return error message on failure

- [x] **Task 3: Create ImageUpload component** (AC: 4, 5, 7)
  - [x] 3.1 Create `components/admin/ImageUpload.tsx` as Client Component
  - [x] 3.2 Define props: `{ value?: string, onChange: (url: string) => void, disabled?: boolean }`
  - [x] 3.3 Add file input with accept="image/jpeg,image/png,image/webp"
  - [x] 3.4 Add drag-and-drop support (optional enhancement)
  - [x] 3.5 Show current image preview if `value` prop is set
  - [x] 3.6 Show upload progress indicator during upload
  - [x] 3.7 On file select, call `uploadProductImage` Server Action
  - [x] 3.8 On success, call `onChange` with new URL and show preview
  - [x] 3.9 On error, show `toast.error()` with message
  - [x] 3.10 Style using shadcn UI patterns and semantic CSS variables

- [x] **Task 4: Integrate ImageUpload into AdminProductForm** (AC: 4, 7)
  - [x] 4.1 Import `ImageUpload` component in `AdminProductForm.tsx`
  - [x] 4.2 Replace current image URL text input with `ImageUpload` component
  - [x] 4.3 Keep URL text input as fallback/alternative (user can paste URL or upload)
  - [x] 4.4 Wire `ImageUpload` to form's `image` field via `onChange`
  - [x] 4.5 Pass current image value to `ImageUpload` for preview
  - [x] 4.6 Test create product with image upload
  - [x] 4.7 Test edit product with image upload replacement

- [x] **Task 5: Migrate existing product images** (AC: 2, 3)
  - [x] 5.1 Create migration script `scripts/migrate-images.ts`
  - [x] 5.2 Read all images from `/public/images/` (excluding logo.svg and hero_img.jpg)
  - [x] 5.3 Upload each image to Supabase Storage `products` bucket
  - [x] 5.4 Map old image paths to new Supabase URLs
  - [x] 5.5 Update `Product.image` in database with new URLs
  - [x] 5.6 Run migration script: `npx tsx scripts/migrate-images.ts`
  - [x] 5.7 Verify all product images display correctly on public site

- [x] **Task 6: Cleanup and verification** (AC: 8)
  - [x] 6.1 Verify product images display on `/products` page
  - [x] 6.2 Verify product images display on `/products/[slug]` detail pages
  - [x] 6.3 Verify product images display in cart
  - [x] 6.4 Verify image upload works in admin create form
  - [x] 6.5 Verify image upload works in admin edit form
  - [x] 6.6 After verification, product images in `/public/images/` can be removed (keep logo.svg)
  - [x] 6.7 Run `npm run lint` and `npm run build` to verify no errors

- [x] **Task 7: Manual testing** (AC: 1-8)
  - [x] 7.1 Test uploading valid JPG image < 2MB → success
  - [x] 7.2 Test uploading valid PNG image < 2MB → success
  - [x] 7.3 Test uploading valid WebP image < 2MB → success
  - [x] 7.4 Test uploading PDF file → error "Only JPG, PNG, WebP allowed"
  - [x] 7.5 Test uploading GIF file → error "Only JPG, PNG, WebP allowed"
  - [x] 7.6 Test uploading image > 2MB → error "Max 2MB"
  - [x] 7.7 Test creating new product with uploaded image → displays on public site
  - [x] 7.8 Test editing product to replace image → new image displays

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.8.story.md#dev-agent-record]

Story 1.8 completed the admin product management dashboard. Key patterns established:

- `AdminProductForm.tsx` is a Client Component using React Hook Form + Zod
- Form uses `useTransition` for pending state and `toast` for feedback
- Current image field is a text input accepting URLs
- Server Actions use `supabaseAdmin` client for privileged operations
- All admin actions verify `session.user.role === 'admin'` before proceeding

The `ImageUpload` component will integrate into the existing `AdminProductForm` structure.

### Supabase Storage Configuration

[Source: architecture/4-data-models-and-schema-changes.md#supabase-storage-bucket-story-19]

```sql
-- Create products bucket for image storage
INSERT INTO storage.buckets (id, name, public)
VALUES ('products', 'products', true);

-- Allow public read access
CREATE POLICY "Public read access" ON storage.objects
  FOR SELECT USING (bucket_id = 'products');

-- Admin-only upload
CREATE POLICY "Admin upload access" ON storage.objects
  FOR INSERT WITH CHECK (
    bucket_id = 'products' AND
    EXISTS (SELECT 1 FROM public.user_profile WHERE id = auth.uid() AND role = 'admin')
  );

-- Admin-only delete
CREATE POLICY "Admin delete access" ON storage.objects
  FOR DELETE USING (
    bucket_id = 'products' AND
    EXISTS (SELECT 1 FROM public.user_profile WHERE id = auth.uid() AND role = 'admin')
  );
```

**Important:** RLS policies on `storage.objects` require the admin user to be authenticated via Supabase Auth. Since we use NextAuth, the Server Action will use `supabaseAdmin` (service role) to bypass RLS for uploads.

### ImageUpload Component Specification

[Source: architecture/5-component-architecture.md#imageupload-component-story-19]

**Location:** `components/admin/ImageUpload.tsx`

**Props Interface:**

```typescript
interface ImageUploadProps {
  value?: string; // Current image URL (for preview)
  onChange: (url: string) => void; // Called with new URL after upload
  disabled?: boolean; // Disable during form submission
}
```

**Technology Stack:**

- Client Component (`"use client"`)
- File input with drag-and-drop (optional)
- Upload progress indicator
- Image preview

### uploadProductImage Server Action

[Source: architecture/6-api-design-and-integration.md#uploadproductimage-admin]

```typescript
"use server";

export async function uploadProductImage(
  formData: FormData,
): Promise<{ success: boolean; message: string; url?: string }> {
  // 1. Get session, verify admin role
  const session = await auth();
  if (session?.user?.role !== "admin") {
    return { success: false, message: "Forbidden: Admin access required" };
  }

  // 2. Extract file from FormData
  const file = formData.get("file") as File | null;
  if (!file) {
    return { success: false, message: "No file provided" };
  }

  // 3. Validate file type (jpg, png, webp)
  const validTypes = ["image/jpeg", "image/png", "image/webp"];
  if (!validTypes.includes(file.type)) {
    return { success: false, message: "Only JPG, PNG, WebP images allowed" };
  }

  // 4. Validate file size (max 2MB)
  const maxSize = 2 * 1024 * 1024; // 2MB
  if (file.size > maxSize) {
    return { success: false, message: "Image must be less than 2MB" };
  }

  // 5. Generate unique filename (uuid + extension)
  const ext = file.name.split(".").pop() || "jpg";
  const filename = `${crypto.randomUUID()}.${ext}`;

  // 6. Upload to 'products' bucket via Supabase admin client
  const { error } = await supabaseAdmin.storage
    .from("products")
    .upload(filename, file, {
      contentType: file.type,
      upsert: false,
    });

  if (error) {
    console.error("Upload error:", error);
    return { success: false, message: "Failed to upload image" };
  }

  // 7. Get public URL
  const { data: urlData } = supabaseAdmin.storage
    .from("products")
    .getPublicUrl(filename);

  return { success: true, message: "Image uploaded", url: urlData.publicUrl };
}
```

### Existing Images to Migrate

[Source: Local file scan]

Product images in `/public/images/`:

- `img1.jpg` through `img6.jpg` - Product images
- `hero_img.jpg` - Hero banner (may not be used after Story 1.2)
- `logo.svg` - Site logo (keep in `/public/`)

**Migration approach:**

1. Upload `img1.jpg` through `img6.jpg` to Supabase Storage
2. Query existing products and update `image` field with new URLs
3. Product images currently stored as paths like `/images/img1.jpg` or full URLs

### File Locations

[Source: architecture/7-source-tree.md]

| File                                    | Type                    | Purpose                   |
| --------------------------------------- | ----------------------- | ------------------------- |
| `components/admin/ImageUpload.tsx`      | Component (NEW)         | Image upload with preview |
| `lib/actions.ts`                        | Server Actions (MODIFY) | Add `uploadProductImage`  |
| `components/admin/AdminProductForm.tsx` | Component (MODIFY)      | Integrate ImageUpload     |
| `scripts/migrate-images.ts`             | Script (NEW)            | One-time migration script |

### UI Standards

[Source: CLAUDE.md, architecture/9-coding-standards.md]

- Use semantic CSS variables (no arbitrary colors like `bg-blue-500`)
- Use shadcn/ui components for UI elements
- Use `.wrapper` for page containers
- Client Components use `"use client"` directive
- Forms use React Hook Form + Zod + `useTransition` + Sonner toast

### Security Considerations

[Source: architecture/11-security-integration.md#5-input-validation-security]

```typescript
// File upload validation in Server Action
const validTypes = ["image/jpeg", "image/png", "image/webp"];
const maxSize = 2 * 1024 * 1024; // 2MB

// Never trust client-side validation alone
// Always validate on server before upload
```

**Important:** The `supabaseAdmin` client (service role) is used for uploads because:

1. NextAuth authentication doesn't map to Supabase Auth
2. RLS policies would require Supabase Auth session
3. Admin role is verified via NextAuth session before using service role

### Supabase Storage URL Format

After upload, public URLs follow this format:

```
https://<project-ref>.supabase.co/storage/v1/object/public/products/<filename>
```

Example:

```
https://xyzabc.supabase.co/storage/v1/object/public/products/a1b2c3d4-5678-90ab-cdef.jpg
```

---

## Testing

### Test Cases

[Source: architecture/10-testing-strategy.md#story-19-image-upload-test-cases]

| #     | Test Case                 | Steps                     | Expected Result               |
| ----- | ------------------------- | ------------------------- | ----------------------------- |
| IMG-1 | Can upload valid image    | Select JPG/PNG/WebP < 2MB | Image uploaded, preview shown |
| IMG-2 | Invalid type rejected     | Select PDF or GIF         | Error message shown           |
| IMG-3 | Oversized file rejected   | Select image > 2MB        | Error message shown           |
| IMG-4 | Image displays on product | Create product with image | Image shows on product page   |

### Integration Verification

| #   | Verification                                              |
| --- | --------------------------------------------------------- |
| IV1 | Existing product images display correctly after migration |
| IV2 | Product detail pages show correct images                  |
| IV3 | Cart shows correct product images                         |
| IV4 | New products can use uploaded images                      |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-01-27 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes List

1. Created Supabase Storage bucket `products` with public read access via SQL migration
2. Added RLS policies for public SELECT, admin INSERT, and admin DELETE on storage.objects
3. Implemented `uploadProductImage` Server Action with full validation (file type, size, admin role)
4. Created `ImageUpload` component with drag-and-drop, preview, and progress indicator
5. Integrated ImageUpload into AdminProductForm with URL input fallback
6. Created and executed migration script to upload 6 product images to Supabase Storage
7. Updated all 24 products in database with new Supabase Storage URLs
8. Build and lint pass successfully
9. All manual browser testing completed successfully by user
10. Product images in `/public/images/` (img1-6.jpg, hero_img.jpg) can now be safely removed (keep logo.svg)

### File List

| File                                                       | Action                                                  |
| ---------------------------------------------------------- | ------------------------------------------------------- |
| `components/admin/ImageUpload.tsx`                         | NEW - Image upload component with drag-drop and preview |
| `lib/actions.ts`                                           | MODIFIED - Added `uploadProductImage` Server Action     |
| `components/admin/AdminProductForm.tsx`                    | MODIFIED - Integrated ImageUpload component             |
| `scripts/migrate-images.ts`                                | NEW - One-time migration script for images              |
| `supabase/migrations/*_create_products_storage_bucket.sql` | NEW - Storage bucket and RLS policies                   |

---

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: STANDARD** (no auto-escalation triggers)

- No auth/payment/security files touched beyond admin upload validation
- Story has 8 acceptance criteria (moderate complexity)
- No previous FAIL/CONCERNS gates for this story
- Implementation follows established patterns from Story 1.8

### Code Quality Assessment

**Overall: EXCELLENT**

The implementation demonstrates high-quality code with excellent adherence to project standards:

1. **ImageUpload Component** ([ImageUpload.tsx](components/admin/ImageUpload.tsx))
   - Clean Client Component with proper `"use client"` directive
   - Excellent use of `useTransition` for loading states
   - Proper drag-and-drop implementation with state management
   - Client-side validation mirrors server-side (defense in depth)
   - Uses semantic CSS variables (`text-muted-foreground`, `border-border`, `bg-primary`)
   - Accessible UI with clear feedback states

2. **uploadProductImage Server Action** ([actions.ts:604-658](lib/actions.ts#L604-L658))
   - Proper admin role verification before any operations
   - Complete file validation (type + size) on server side
   - Secure filename generation using `crypto.randomUUID()`
   - Uses `supabaseAdmin` for service-role operations
   - Consistent error handling with `formatError()`
   - Returns structured response matching project conventions

3. **AdminProductForm Integration** ([AdminProductForm.tsx](components/admin/AdminProductForm.tsx))
   - Clean integration with ImageUpload component
   - Maintains URL input as fallback option (good UX)
   - Proper form field binding through React Hook Form
   - Consistent styling with project standards

4. **Migration Script** ([migrate-images.ts](scripts/migrate-images.ts))
   - Well-structured one-time migration script
   - Environment variable validation
   - Clear console output for progress tracking
   - Proper error handling at each step

### Refactoring Performed

None required. The implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ All code follows TypeScript strict mode, ESLint passes
- Project Structure: ✓ Files placed in correct locations per architecture
- Testing Strategy: ✓ Manual test cases documented and executed (no automated tests in project)
- All ACs Met: ✓ All 8 acceptance criteria implemented

### Acceptance Criteria Validation

| AC  | Status | Validation                                                                      |
| --- | ------ | ------------------------------------------------------------------------------- |
| AC1 | ✓      | Supabase Storage bucket `products` created with public read (per Dev Notes SQL) |
| AC2 | ✓      | Migration script executed, 6 images uploaded to Supabase                        |
| AC3 | ✓      | All 24 products updated with Supabase URLs                                      |
| AC4 | ✓      | Admin form includes ImageUpload component                                       |
| AC5 | ✓      | Server Action validates type (jpg/png/webp) and size (2MB max)                  |
| AC6 | ✓      | UUID-based filenames prevent conflicts                                          |
| AC7 | ✓      | Image preview shown in ImageUpload component                                    |
| AC8 | ✓      | `/public/images/` product images can be removed (logo.svg retained)             |

### Requirements Traceability (Given-When-Then)

| AC    | Test Scenario                                                                                                    |
| ----- | ---------------------------------------------------------------------------------------------------------------- |
| AC1   | **Given** admin dashboard, **When** image uploaded, **Then** stored in `products` bucket with public URL         |
| AC4-5 | **Given** admin product form, **When** file selected, **Then** validated for type (jpg/png/webp) and size (<2MB) |
| AC5   | **Given** invalid file type, **When** upload attempted, **Then** error "Only JPG, PNG, WebP images allowed"      |
| AC5   | **Given** oversized file, **When** upload attempted, **Then** error "Image must be less than 2MB"                |
| AC6   | **Given** any valid image, **When** uploaded, **Then** receives UUID-based filename                              |
| AC7   | **Given** image uploaded, **When** successful, **Then** preview displayed in form                                |

### Security Review

**Status: PASS**

1. **Authentication**: Admin role verified in Server Action before any storage operations ✓
2. **Authorization**: Uses `supabaseAdmin` (service role) with NextAuth session verification ✓
3. **Input Validation**:
   - Server-side MIME type validation (not just extension) ✓
   - File size limit enforced on server ✓
   - Client-side validation provides defense in depth ✓
4. **Secure Storage**: UUID filenames prevent enumeration attacks ✓
5. **No Secrets Exposed**: Service role key only used server-side ✓

**Note**: The Dev Notes correctly document that RLS policies use Supabase Auth, but since NextAuth is used, the Server Action bypasses RLS with service role after verifying admin role via NextAuth session. This is the correct pattern.

### Performance Considerations

**Status: PASS**

1. **File Size Limit**: 2MB limit prevents excessive upload times/storage
2. **Image Optimization**: Next.js Image component used for rendering
3. **Progress Indicator**: Loading state shown during upload
4. **No N+1 Queries**: Migration script handles batch updates appropriately

**Recommendation (Future)**: Consider adding image compression/resizing before upload for consistently optimized images.

### Improvements Checklist

All items implemented by developer:

- [x] Server-side file type validation
- [x] Server-side file size validation
- [x] Admin role verification
- [x] UUID-based secure filenames
- [x] Image preview functionality
- [x] Drag-and-drop support
- [x] Progress indicator during upload
- [x] URL input fallback option
- [x] Migration script for existing images
- [x] Build and lint pass

**Future Considerations (not blocking)**:

- [ ] Consider image compression/optimization before upload
- [ ] Consider implementing image delete from storage when product deleted
- [ ] Consider adding alt text field for accessibility

### Files Modified During Review

No files modified during this review.

### Gate Status

Gate: **PASS** → docs/qa/gates/1.9-image-migration-supabase-storage.yml

### Recommended Status

✓ **Ready for Done**

The implementation is complete, follows all project standards, and passes security review. All acceptance criteria are met with comprehensive validation and proper error handling.
