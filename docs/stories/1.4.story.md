# Story 1.4: Product Search

## Status

Done

## Story

**As a** customer,
**I want** to search for products by name,
**so that** I can quickly find what I'm looking for.

## Acceptance Criteria

| #   | Criteria                                                                |
| --- | ----------------------------------------------------------------------- |
| AC1 | Search trigger button/icon visible in header                            |
| AC2 | Clicking opens command palette modal (shadcn `command` + `dialog`)      |
| AC3 | User can type to filter products by name (case-insensitive)             |
| AC4 | Results appear instantly as user types                                  |
| AC5 | Each result shows product name and price                                |
| AC6 | Clicking result navigates to product detail page                        |
| AC7 | Keyboard navigation: Up/Down to navigate, Enter to select, Esc to close |
| AC8 | Empty state shown when no results                                       |
| AC9 | Modal closes after selection or Esc                                     |

## Tasks / Subtasks

- [x] **Task 1: Install required shadcn components** (AC: 2)
  - [x] 1.1 Run `npx shadcn@latest add command dialog`
  - [x] 1.2 Verify `components/ui/command.tsx` exists
  - [x] 1.3 Verify `components/ui/dialog.tsx` exists

- [x] **Task 2: Create SearchCommand component** (AC: 2, 3, 4, 5, 6, 7, 8, 9)
  - [x] 2.1 Create directory `components/search/`
  - [x] 2.2 Create `components/search/SearchCommand.tsx` as Client Component
  - [x] 2.3 Import shadcn `Command`, `CommandInput`, `CommandList`, `CommandEmpty`, `CommandGroup`, `CommandItem` from `@/components/ui/command`
  - [x] 2.4 Import shadcn `Dialog`, `DialogContent` from `@/components/ui/dialog` (using CommandDialog which wraps both)
  - [x] 2.5 Define props interface: `{ products: Product[], open: boolean, onOpenChange: (open: boolean) => void }`
  - [x] 2.6 Implement search input with `CommandInput` placeholder "Search products..."
  - [x] 2.7 Filter products case-insensitively on product `name` field (handled by cmdk)
  - [x] 2.8 Display matching products in `CommandGroup` with `CommandItem` for each
  - [x] 2.9 Each result shows: product name and formatted price
  - [x] 2.10 Use `useRouter` from `next/navigation` for programmatic navigation
  - [x] 2.11 On item selection: navigate to `/products/${product.slug}` and close modal
  - [x] 2.12 Display `CommandEmpty` with "No products found." message when no results
  - [x] 2.13 Style using semantic CSS variables (`bg-background`, `text-foreground`, etc.)

- [x] **Task 3: Create SearchTrigger wrapper component** (AC: 1)
  - [x] 3.1 Create `components/search/SearchTrigger.tsx` as Client Component
  - [x] 3.2 Manage `open` state with `useState`
  - [x] 3.3 Render search button with `Search` icon from Lucide React
  - [x] 3.4 On button click, set `open` to `true`
  - [x] 3.5 Pass `products` prop to `SearchCommand` child
  - [x] 3.6 Pass `open` and `onOpenChange` to control modal state

- [x] **Task 4: Modify Header to include search** (AC: 1)
  - [x] 4.1 The Header is currently a Server Component that fetches session
  - [x] 4.2 Fetch products in Header using `getProducts()` from `@/lib/data-service`
  - [x] 4.3 Import and render `SearchTrigger` component, passing `products` prop
  - [x] 4.4 Position search button before CartIcon in desktop view (hidden md:flex section)
  - [x] 4.5 Add search button to mobile Sheet menu in appropriate location

- [x] **Task 5: Style the search components** (AC: 5)
  - [x] 5.1 Use `formatNumberWithDecimal` from `@/lib/utils` for price display
  - [x] 5.2 Ensure proper spacing and alignment in result items
  - [x] 5.3 Use `text-muted-foreground` for price text

- [x] **Task 6: Manual Integration Testing**
  - [x] 6.1 Click search icon in header - verify command palette opens (AC: 1, 2, SRCH-1)
  - [x] 6.2 Type product name - verify matching products shown (AC: 3, 4, SRCH-2)
  - [x] 6.3 Type lowercase for uppercase product - verify found (AC: 3, SRCH-3)
  - [x] 6.4 Search for nonexistent product - verify "No products found" message (AC: 8, SRCH-4)
  - [x] 6.5 Click on result - verify navigation to product page (AC: 6, SRCH-5)
  - [x] 6.6 Use arrow keys and Enter - verify keyboard navigation works (AC: 7)
  - [x] 6.7 Press Escape - verify modal closes (AC: 9, SRCH-6)
  - [x] 6.8 Verify header layout intact on desktop (IV1)
  - [x] 6.9 Verify header layout intact on mobile (IV1)
  - [x] 6.10 Verify category filtering still works on products page (IV2)
  - [x] 6.11 Verify product detail pages load correctly from search results (IV3)

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.3.story.md#dev-agent-record]

Story 1.3 established patterns for:

- Using `redirect()` from `next/navigation` for page redirects
- Minimal, focused implementations
- QA discovered missed internal links - thoroughly check all integration points (header desktop, header mobile, keyboard shortcuts)
- The Header component is a Server Component that fetches session data
- Adding new imports to existing components follows the established import organization pattern

### Component Specifications

[Source: architecture/5-component-architecture.md#searchcommand-component-story-14]

**SearchCommand Component:**

- **Location:** `components/search/SearchCommand.tsx`
- **Type:** Client Component ("use client") - requires useState for search input, keyboard events
- **Responsibility:** Provides a command palette modal for instant product search with keyboard navigation
- **Props:** `{ products: Product[], open: boolean, onOpenChange: (open: boolean) => void }`
- **Dependencies:** shadcn `command`, `dialog`

**Integration Points:**

- Triggered from Header component (search icon button)
- Navigates to product detail pages on selection
- Receives product list as prop (pre-fetched by parent)

**Key imports to use:**

```typescript
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Search } from "lucide-react";
import {
  Command,
  CommandDialog,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandItem,
  CommandList,
} from "@/components/ui/command";
import { formatNumberWithDecimal } from "@/lib/utils";
import { Product } from "@/types";
```

**Note:** shadcn's `CommandDialog` combines Dialog + Command - use this instead of separate Dialog wrapping for cleaner implementation.

### Data Models

[Source: architecture/4-data-models-and-schema-changes.md#existing-database-schema]

**Product table structure (relevant fields for search display):**

```
| Column    | Type    | Notes                    |
|-----------|---------|--------------------------|
| id        | bigint  | Primary key (identity)   |
| name      | string  | Searchable field         |
| slug      | string  | URL slug for navigation  |
| category  | string  | Display in results       |
| price     | numeric | Display formatted price  |
```

**Product type from types.ts:**

```typescript
type Product = {
  id: number;
  name: string;
  slug: string;
  category: string;
  brand: string;
  description: string;
  stock: number;
  image: string;
  price: string;
  created_at: string;
};
```

### File Locations

[Source: architecture/7-source-tree.md#new-files-summary]

| File                                       | Type   | Purpose                          |
| ------------------------------------------ | ------ | -------------------------------- |
| `components/search/SearchCommand.tsx`      | NEW    | Command palette search component |
| `components/search/SearchTrigger.tsx`      | NEW    | Client wrapper for search button |
| `components/layout/root_layout/Header.tsx` | MODIFY | Add search trigger button        |

### Existing Code Patterns to Reference

[Source: Code review of existing components]

**Header.tsx (current structure):**

- Server Component that calls `await auth()` for session
- Desktop view: `hidden md:flex` section with CartIcon, ThemeToggle, UserMenu
- Mobile view: Sheet component with navigation
- Search trigger should be added before CartIcon in desktop view

**Recommended pattern for search trigger placement in Header desktop section:**

```tsx
<div className="hidden md:flex items-center gap-2">
  <SearchTrigger products={products} /> {/* NEW - add before CartIcon */}
  <Link href="/cart">
    <CartIcon />
  </Link>
  <ThemeToggle />
  {/* ... auth section ... */}
</div>
```

**ProductCard.tsx (price formatting pattern):**

```tsx
import { formatNumberWithDecimal } from "@/lib/utils";
// ...
<span>${formatNumberWithDecimal(product.price)}</span>;
```

### Coding Standards

[Source: architecture/9-coding-standards.md]

**UI Standards:**

- Use semantic CSS variables: `bg-background`, `text-foreground`, `text-muted-foreground`, etc.
- Never use arbitrary Tailwind colors like `bg-blue-500`
- Use `cn()` from `@/lib/utils` if combining classes conditionally

**Client Component Pattern:**

```tsx
"use client";

import { useState } from "react";
import { Search } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Product } from "@/types";
import { SearchCommand } from "./SearchCommand";

export function SearchTrigger({ products }: { products: Product[] }) {
  const [open, setOpen] = useState(false);

  return (
    <>
      <Button variant="ghost" size="icon" onClick={() => setOpen(true)}>
        <Search className="h-4 w-4" />
      </Button>
      <SearchCommand products={products} open={open} onOpenChange={setOpen} />
    </>
  );
}
```

**Import Organization:**

```tsx
// 1. React/Next.js imports
import { useState } from "react";
import { useRouter } from "next/navigation";

// 2. Third-party imports
import { Search } from "lucide-react";

// 3. Internal imports (absolute paths with @/)
import { Button } from "@/components/ui/button";
import { CommandDialog, CommandInput, ... } from "@/components/ui/command";
import { formatNumberWithDecimal } from "@/lib/utils";
import { Product } from "@/types";

// 4. Relative imports (same-feature files)
import { SearchCommand } from "./SearchCommand";
```

### Technical Constraints

[Source: architecture/9-coding-standards.md#critical-integration-rules]

- Path aliases: Always use `@/` prefix for imports from project root
- Type safety: All new functions must be fully typed; no `any` types
- Existing API compatibility: Don't modify existing function signatures
- The Header is a Server Component - use a Client Component wrapper (SearchTrigger) for interactive functionality

### shadcn Command Component Usage

[Source: shadcn/ui documentation patterns]

The shadcn `command` component provides built-in:

- Fuzzy search (but we'll do exact case-insensitive for simplicity)
- Keyboard navigation (Up/Down arrows, Enter to select)
- Escape to close
- Accessible markup

**CommandDialog** combines Dialog + Command for modal usage:

```tsx
<CommandDialog open={open} onOpenChange={onOpenChange}>
  <CommandInput placeholder="Search products..." />
  <CommandList>
    <CommandEmpty>No products found.</CommandEmpty>
    <CommandGroup heading="Products">
      {filteredProducts.map((product) => (
        <CommandItem
          key={product.id}
          value={product.name}
          onSelect={() => {
            router.push(`/products/${product.slug}`);
            onOpenChange(false);
          }}
        >
          {/* Product display */}
        </CommandItem>
      ))}
    </CommandGroup>
  </CommandList>
</CommandDialog>
```

### Testing

[Source: architecture/10-testing-strategy.md#story-14-product-search-test-cases]

**Manual Test Cases:**

| #      | Test Case                  | Steps                                | Expected Result           |
| ------ | -------------------------- | ------------------------------------ | ------------------------- |
| SRCH-1 | Search opens with click    | Click search icon in header          | Command palette opens     |
| SRCH-2 | Search filters products    | Type product name                    | Matching products shown   |
| SRCH-3 | Search is case-insensitive | Type lowercase for uppercase product | Product found             |
| SRCH-4 | Empty state shows          | Search for nonexistent product       | "No results" message      |
| SRCH-5 | Selection navigates        | Click or Enter on result             | Navigates to product page |
| SRCH-6 | Escape closes              | Press Escape                         | Modal closes              |

**Integration Verification:**

| #   | Verification                                    |
| --- | ----------------------------------------------- |
| IV1 | Header layout intact on desktop and mobile      |
| IV2 | Existing category filtering still works         |
| IV3 | Product detail pages load correctly from search |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-01-18 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - no blocking issues encountered.

### Completion Notes List

- Installed shadcn `command` and `dialog` components
- Created `SearchCommand` component using `CommandDialog` (combines Dialog + Command)
- Created `SearchTrigger` wrapper to manage modal state
- Integrated search into Header (desktop and mobile)
- Fixed mobile menu alignment to match CartIcon styling
- All manual tests passed

### File List

| File                                       | Action       |
| ------------------------------------------ | ------------ |
| `components/ui/command.tsx`                | NEW (shadcn) |
| `components/ui/dialog.tsx`                 | NEW (shadcn) |
| `components/search/SearchCommand.tsx`      | NEW          |
| `components/search/SearchTrigger.tsx`      | NEW          |
| `components/layout/root_layout/Header.tsx` | MODIFIED     |

---

## QA Results

### Review Date: 2026-01-19

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** — The implementation follows established project patterns and coding standards. Clean separation of concerns between SearchCommand (modal logic) and SearchTrigger (state management). Proper use of shadcn/ui components and semantic CSS variables.

**Key Observations:**

- All 9 acceptance criteria have corresponding implementations
- Import organization follows project standards
- Accessibility considerations included (sr-only labels, dialog title/description)
- Server-side product fetching pattern is appropriate for current scale

### Refactoring Performed

None required — code quality is satisfactory.

### Compliance Check

- Coding Standards: ✓ Uses shadcn components, semantic CSS variables, proper import organization
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✓ Manual test cases completed (Task 6 verified)
- All ACs Met: ✓ All 9 acceptance criteria implemented and verified

### Improvements Checklist

- [x] Search trigger in desktop header (before CartIcon)
- [x] Search trigger in mobile Sheet menu
- [x] Accessible dialog with title/description
- [x] sr-only label for screen readers
- [x] Manual testing completed (Task 6)
- [x] Dev Agent Record populated with File List
- [ ] Consider keyboard shortcut (Cmd+K/Ctrl+K) as future enhancement (mentioned in SRCH-2 but not in AC)

### Security Review

**Status: PASS**

- No authentication/authorization concerns
- Read-only product data access
- No user data exposure risks

### Performance Considerations

**Status: PASS** (with advisory note)

- All products fetched on every page via Header component
- **Current Impact**: Acceptable for current product catalog size
- **Future Advisory**: For significantly larger catalogs (1000+ products), consider:
  - Search API endpoint with server-side filtering
  - Client-side caching/memoization
  - Virtual scrolling for result lists

### Files Modified During Review

None — no refactoring required.

### Gate Status

**Gate: PASS** → docs/qa/gates/1.4-product-search.yml

### Recommended Status

✓ **Ready for Done** — All acceptance criteria met, manual testing completed, code quality satisfactory.

(Story owner decides final status)
