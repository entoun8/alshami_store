# Story 2.4: SEO & Metadata Optimization

## Status

Draft

## Story

**As a** store owner,
**I want** proper SEO configuration on all pages,
**so that** the store ranks well in search engines.

## Acceptance Criteria

| #   | Criteria                                                                                                     |
| --- | ------------------------------------------------------------------------------------------------------------ |
| AC1 | All pages have appropriate `<title>` tags                                                                    |
| AC2 | All pages have meta descriptions                                                                             |
| AC3 | Product pages have dynamic titles including product name                                                     |
| AC4 | Open Graph metadata configured for social sharing (og:title, og:description, og:image)                       |
| AC5 | Canonical URLs set appropriately                                                                             |
| AC6 | robots.txt and sitemap.xml present (if applicable)                                                           |
| AC7 | No duplicate title tags or meta descriptions                                                                 |

## Tasks / Subtasks

- [ ] **Task 1: Audit Current Metadata State** (AC: 1, 2, 7)
  - [ ] 1.1 Review all page.tsx files for existing metadata exports
  - [ ] 1.2 Document which pages have titles vs missing titles
  - [ ] 1.3 Document which pages have meta descriptions vs missing
  - [ ] 1.4 Check root layout.tsx for base metadata configuration
  - [ ] 1.5 Verify no duplicate metadata issues exist

- [ ] **Task 2: Add/Update Static Page Metadata** (AC: 1, 2)
  - [ ] 2.1 Update `app/(root)/products/page.tsx` - add description
  - [ ] 2.2 Update `app/(root)/cart/page.tsx` - add description
  - [ ] 2.3 Update `app/(root)/about/page.tsx` - add description
  - [ ] 2.4 Update `app/(root)/contact/page.tsx` - add title and description
  - [ ] 2.5 Update `app/(root)/user/profile/page.tsx` - add description
  - [ ] 2.6 Update `app/(root)/user/orders/page.tsx` - add description
  - [ ] 2.7 Update `app/(root)/shipping-address/page.tsx` - add title and description
  - [ ] 2.8 Update `app/(root)/payment-method/page.tsx` - add title and description
  - [ ] 2.9 Update `app/(root)/place-order/page.tsx` - add title and description
  - [ ] 2.10 Update `app/(root)/order/[id]/page.tsx` - add description
  - [ ] 2.11 Update `app/(auth)/sign-in/page.tsx` - add title and description
  - [ ] 2.12 Update admin pages - add noindex for search exclusion

- [ ] **Task 3: Add Dynamic Product Page Metadata** (AC: 1, 2, 3, 4)
  - [ ] 3.1 Add `generateMetadata` function to `app/(root)/products/[slug]/page.tsx`
  - [ ] 3.2 Fetch product data for metadata generation
  - [ ] 3.3 Set dynamic title: "{Product Name} | Alshami"
  - [ ] 3.4 Set dynamic description from product description (truncated if needed)
  - [ ] 3.5 Add Open Graph metadata (og:title, og:description, og:image, og:type)
  - [ ] 3.6 Add Twitter Card metadata (twitter:card, twitter:title, twitter:description, twitter:image)

- [ ] **Task 4: Configure Open Graph for Key Pages** (AC: 4)
  - [ ] 4.1 Update root layout metadata with default Open Graph config
  - [ ] 4.2 Add og:site_name to root metadata
  - [ ] 4.3 Add og:locale to root metadata
  - [ ] 4.4 Add Twitter card defaults to root metadata
  - [ ] 4.5 Ensure home/products page has proper OG image fallback

- [ ] **Task 5: Add Canonical URLs** (AC: 5)
  - [ ] 5.1 Verify `metadataBase` is set correctly in root layout
  - [ ] 5.2 Update `SERVER_URL` in constants.ts for production URL
  - [ ] 5.3 Add canonical URL configuration to product detail pages
  - [ ] 5.4 Ensure canonical URLs use clean slugs (no query params)

- [ ] **Task 6: Create robots.txt** (AC: 6)
  - [ ] 6.1 Create `app/robots.ts` file using Next.js robots function
  - [ ] 6.2 Allow crawling of public pages (/, /products, /products/*, /about, /contact)
  - [ ] 6.3 Disallow crawling of user pages (/user/*, /cart, /shipping-address, /payment-method, /place-order, /order/*)
  - [ ] 6.4 Disallow crawling of admin pages (/admin/*)
  - [ ] 6.5 Disallow crawling of auth pages (/sign-in)
  - [ ] 6.6 Reference sitemap in robots.txt

- [ ] **Task 7: Create Sitemap** (AC: 6)
  - [ ] 7.1 Create `app/sitemap.ts` file using Next.js sitemap function
  - [ ] 7.2 Include static pages: /, /products, /about, /contact
  - [ ] 7.3 Dynamically generate product page URLs from database
  - [ ] 7.4 Set appropriate changeFrequency and priority values
  - [ ] 7.5 Set lastModified dates (use product.created_at for products)

- [ ] **Task 8: Admin Page Search Exclusion** (AC: 6)
  - [ ] 8.1 Add `robots: { index: false, follow: false }` to admin layout or pages
  - [ ] 8.2 Verify admin pages return noindex meta tag

- [ ] **Task 9: Build and Verification** (AC: 1-7)
  - [ ] 9.1 Run `npm run build` and verify no errors
  - [ ] 9.2 Run `npm run lint` and verify no errors
  - [ ] 9.3 Start production build and verify metadata in browser DevTools
  - [ ] 9.4 Test product page metadata changes dynamically
  - [ ] 9.5 Verify /robots.txt returns correct content
  - [ ] 9.6 Verify /sitemap.xml returns valid XML with product URLs

---

## Dev Notes

### Previous Story Insights

[Source: docs/stories/2.3.story.md#dev-agent-record]

Story 2.3 (Loading States) confirmed `npm run build` and `npm run lint` pass. All pages have proper loading skeletons. The codebase is stable and ready for SEO enhancements.

[Source: docs/stories/2.2.story.md#dev-agent-record]

Story 2.2 (Codebase Consistency) verified that the codebase follows consistent patterns including the `.wrapper` class and semantic CSS variables. All pages render correctly.

### Current Metadata State

[Source: Codebase analysis]

**Root Layout Metadata (`app/layout.tsx`):**

```tsx
import { APP_DESCRIPTION, APP_NAME, SERVER_URL } from "@/lib/constants";

export const metadata: Metadata = {
  title: APP_NAME,                    // "Alshami"
  description: APP_DESCRIPTION,       // "A modern e-commerce platform..."
  metadataBase: new URL(SERVER_URL),  // "http://localhost:3000"
};
```

**Pages with Existing Metadata:**

| Page                               | Has Title | Has Description |
| ---------------------------------- | --------- | --------------- |
| `app/layout.tsx` (root)            | ✓         | ✓               |
| `app/(root)/about/page.tsx`        | ✓         | ✗               |
| `app/(root)/cart/page.tsx`         | ✓         | ✗               |
| `app/(root)/user/orders/page.tsx`  | ✓         | ✗               |

**Pages Missing Metadata:**

| Page                                        | Missing           |
| ------------------------------------------- | ----------------- |
| `app/(root)/products/page.tsx`              | Title, Desc       |
| `app/(root)/products/[slug]/page.tsx`       | All (CRITICAL)    |
| `app/(root)/contact/page.tsx`               | Unknown           |
| `app/(root)/shipping-address/page.tsx`      | Unknown           |
| `app/(root)/payment-method/page.tsx`        | Unknown           |
| `app/(root)/place-order/page.tsx`           | Unknown           |
| `app/(root)/order/[id]/page.tsx`            | Unknown           |
| `app/(root)/user/profile/page.tsx`          | Unknown           |
| `app/(auth)/sign-in/page.tsx`               | Unknown           |
| `app/(admin)/admin/products/page.tsx`       | Unknown           |
| `app/(admin)/admin/products/new/page.tsx`   | Unknown           |
| `app/(admin)/admin/products/[id]/edit/page.tsx` | Unknown       |

**Missing SEO Infrastructure:**
- No `robots.txt` file
- No `sitemap.xml` file
- No Open Graph metadata
- No dynamic metadata on product pages
- Product detail pages have NO metadata at all

### Next.js Metadata API Reference

[Source: Next.js Documentation]

**Static Metadata Pattern:**

```tsx
// app/(root)/products/page.tsx
import type { Metadata } from "next";
import { APP_NAME } from "@/lib/constants";

export const metadata: Metadata = {
  title: `Our Products | ${APP_NAME}`,
  description: "Browse our curated selection of premium herbs, coffees, and more.",
};
```

**Dynamic Metadata Pattern (for product pages):**

```tsx
// app/(root)/products/[slug]/page.tsx
import type { Metadata } from "next";
import { getProductBySlug } from "@/lib/data-service";
import { APP_NAME, SERVER_URL } from "@/lib/constants";

type Props = {
  params: Promise<{ slug: string }>;
};

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { slug } = await params;
  const product = await getProductBySlug(slug);

  if (!product) {
    return {
      title: `Product Not Found | ${APP_NAME}`,
    };
  }

  return {
    title: `${product.name} | ${APP_NAME}`,
    description: product.description.substring(0, 160),
    openGraph: {
      title: `${product.name} | ${APP_NAME}`,
      description: product.description.substring(0, 160),
      images: [{ url: product.image }],
      type: "website",
    },
    twitter: {
      card: "summary_large_image",
      title: `${product.name} | ${APP_NAME}`,
      description: product.description.substring(0, 160),
      images: [product.image],
    },
  };
}
```

**robots.ts Pattern:**

```tsx
// app/robots.ts
import type { MetadataRoute } from "next";
import { SERVER_URL } from "@/lib/constants";

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [
      {
        userAgent: "*",
        allow: ["/", "/products", "/about", "/contact"],
        disallow: ["/user/", "/cart", "/shipping-address", "/payment-method", "/place-order", "/order/", "/admin/", "/sign-in"],
      },
    ],
    sitemap: `${SERVER_URL}/sitemap.xml`,
  };
}
```

**sitemap.ts Pattern:**

```tsx
// app/sitemap.ts
import type { MetadataRoute } from "next";
import { getProducts } from "@/lib/data-service";
import { SERVER_URL } from "@/lib/constants";

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const products = await getProducts();

  const productUrls = products.map((product) => ({
    url: `${SERVER_URL}/products/${product.slug}`,
    lastModified: new Date(product.created_at),
    changeFrequency: "weekly" as const,
    priority: 0.8,
  }));

  return [
    {
      url: SERVER_URL,
      lastModified: new Date(),
      changeFrequency: "daily",
      priority: 1,
    },
    {
      url: `${SERVER_URL}/products`,
      lastModified: new Date(),
      changeFrequency: "daily",
      priority: 0.9,
    },
    {
      url: `${SERVER_URL}/about`,
      lastModified: new Date(),
      changeFrequency: "monthly",
      priority: 0.5,
    },
    {
      url: `${SERVER_URL}/contact`,
      lastModified: new Date(),
      changeFrequency: "monthly",
      priority: 0.5,
    },
    ...productUrls,
  ];
}
```

### File Locations

[Source: architecture/7-source-tree.md]

| File                                   | Type     | Purpose                           |
| -------------------------------------- | -------- | --------------------------------- |
| `app/layout.tsx`                       | Layout   | Root layout with base metadata    |
| `app/robots.ts`                        | Route    | robots.txt generation (NEW)       |
| `app/sitemap.ts`                       | Route    | sitemap.xml generation (NEW)      |
| `app/(root)/products/[slug]/page.tsx`  | Page     | Product detail - needs dynamic metadata |
| `lib/constants.ts`                     | Utility  | APP_NAME, SERVER_URL constants    |

### Constants Reference

[Source: lib/constants.ts]

```typescript
export const APP_NAME = "Alshami";
export const APP_DESCRIPTION = "A modern e-commerce platform for premium herbs, coffees, and more.";
export const SERVER_URL = "http://localhost:3000";  // Update for production!
```

**IMPORTANT:** `SERVER_URL` must be updated to the production URL before deployment for proper canonical URLs and sitemap generation.

### Open Graph Best Practices

[Source: Open Graph Protocol]

**Required OG Tags:**
- `og:title` - Page title (same as HTML title)
- `og:description` - Brief description (under 200 chars)
- `og:image` - Image URL (1200x630 recommended)
- `og:type` - "website" for pages, "product" for products

**Twitter Card Tags:**
- `twitter:card` - "summary_large_image" for products
- `twitter:title` - Same as og:title
- `twitter:description` - Same as og:description
- `twitter:image` - Same as og:image

### Admin Page Noindex Configuration

[Source: Next.js Documentation]

To exclude admin pages from search engines:

```tsx
// app/(admin)/layout.tsx or individual admin pages
export const metadata: Metadata = {
  robots: {
    index: false,
    follow: false,
  },
};
```

### Data Service Reference

[Source: lib/data-service.ts]

**Available Functions for Sitemap:**
- `getProducts()` - Returns all products (can be used for sitemap generation)
- `getProductBySlug(slug)` - Returns single product (for dynamic metadata)

### Integration Verification Points

[Source: docs/prd/7-epic-2-production-readiness-polish.md#story-24]

| #   | Verification                                   |
| --- | ---------------------------------------------- |
| IV1 | Social media preview shows correct information |
| IV2 | Search engine can crawl public pages           |
| IV3 | Admin pages excluded from search indexing      |

---

## Testing

### Test File Location

No automated tests - manual testing only (per project testing strategy).

### Testing Standards

[Source: architecture/10-testing-strategy.md#regression-testing]

| Area               | Verification Steps                                             |
| ------------------ | -------------------------------------------------------------- |
| Product Browsing   | Products page loads with proper title and description          |
| Product Detail     | Product page shows dynamic title matching product name         |
| Social Sharing     | Social media previews render correctly                         |
| SEO Crawlability   | robots.txt allows/disallows correct paths                      |
| Sitemap            | sitemap.xml contains all public pages and products             |

### Testing Framework

Manual testing with browser DevTools and SEO validation tools.

### SEO Verification Tests

| #     | Test Case                    | Steps                                               | Expected Result                              |
| ----- | ---------------------------- | --------------------------------------------------- | -------------------------------------------- |
| SEO-1 | Product page has dynamic title | Navigate to /products/[slug], check <title>        | Title includes product name                  |
| SEO-2 | Product page has OG metadata   | Inspect <meta property="og:*"> tags                | og:title, og:description, og:image present   |
| SEO-3 | robots.txt accessible          | Navigate to /robots.txt                            | Valid robots.txt content displayed           |
| SEO-4 | sitemap.xml accessible         | Navigate to /sitemap.xml                           | Valid XML with product URLs                  |
| SEO-5 | Admin pages not indexed        | Check admin page source for noindex                | robots meta tag shows noindex                |
| SEO-6 | Social preview works           | Use Facebook Sharing Debugger or Twitter Card Validator | Preview shows correct title, desc, image   |
| SEO-7 | All pages have titles          | Navigate each page, check <title>                  | Unique, descriptive title present            |
| SEO-8 | All pages have descriptions    | Inspect each page <meta name="description">        | Description present and meaningful           |
| SEO-9 | No duplicate titles            | Compare titles across pages                        | Each page has unique title                   |
| SEO-10 | Build passes                   | Run npm run build                                  | Build completes successfully                 |
| SEO-11 | Lint passes                    | Run npm run lint                                   | No linting errors                            |

### SEO Validation Tools

| Tool                        | URL                                    | Purpose                     |
| --------------------------- | -------------------------------------- | --------------------------- |
| Facebook Sharing Debugger   | https://developers.facebook.com/tools/debug/ | Test OG metadata        |
| Twitter Card Validator      | https://cards-dev.twitter.com/validator | Test Twitter cards         |
| Google Rich Results Test    | https://search.google.com/test/rich-results | Test structured data     |
| XML Sitemap Validator       | https://www.xml-sitemaps.com/validate-xml-sitemap.html | Validate sitemap |

---

## Change Log

| Date       | Version | Description         | Author         |
| ---------- | ------- | ------------------- | -------------- |
| 2026-02-12 | 1.0     | Initial story draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent after implementation_
